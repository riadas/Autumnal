<div id="content-wrapper">
  <div id="header" style="display: none;">
    <span id="title">autumnal</span> <span id="playground">playground</span> <span id="challenges">challenges</span>
  </div>
  <div id="dashboard">
    <div id="model-input" class="dashboard-panel" style="border-right: 3px solid black;">
      <form style="width: 100%; margin: 0; font-size: 13px !important; height: 100%;">
      <textarea id="autumn-string" name="autumnstring" rows="30" cols="50"
      style="height: 97%; width: 100%;" spellcheck="false">
      </textarea>
      </form> 
    </div>
     
    <div id="grid-view" class="dashboard-panel" style="border-left: 3px solid black;">
      <div id="button-div" style="display: flex; flex-wrap: wrap; height: fit-content; margin-left: 10px;">
        <button id="compile-button" class="control-button"></button>
        <button id="particles-button" class="control-button example-button">PARTICLES</button>
        <button id="ants-button" class="control-button example-button">ANTS</button>
        <button id="light-button" class="control-button example-button">LIGHTS</button>
        <button id="magnets-button" class="control-button example-button">MAGNETS</button>
        <button id="plug-button" class="control-button example-button">WATER PLUG</button>
        <button id="ice-button" class="control-button example-button">ICE</button>
        <button id="tetris-button" style="display: none" class="control-button example-button">TETRIS</button>
        <button id="hatch-button" style="display: none" class="control-button example-button">EGG</button>
        <button id="snake-button" style="display: none" class="control-button example-button">SNAKE</button>
        <button id="magnets-button-2" style="display: none" class="control-button example-button">MAGNETS II</button>
        <button id="magnets-button-3" style="display: none" class="control-button example-button">MAGNETS III</button>
        <button id="lock-button" style="display: none" class="control-button example-button">LOCK</button>
        <button id="bbq-button" style="display: none" class="control-button example-button">BBQ</button>
        <button id="bottle-button" style="display: none" class="control-button example-button">BOTTLE</button>
        <button id="disease-button" class="control-button example-button">DISEASE</button>
        <button id="balls-button-1" style="display: none" class="control-button example-button">BALLS I</button>
        <button id="balls-button-2" style="display: none" class="control-button example-button">BALLS II</button>
        <button id="space-button" class="control-button example-button">SPACE INVADERS</button>
        <button id="gol-button" style="display: none" class="control-button example-button">GoL</button>
        <button id="sokoban-button" class="control-button example-button">SOKOBAN</button>
        <button id="sokoban-button-2" style="display: none" class="control-button example-button">SOKOBAN II</button>
        <button id="grow-button" class="control-button example-button">GROW</button>
        <button id="mario-button" class="control-button example-button">MARIO</button>
        <button id="sand-button" class="control-button example-button">SAND</button>
        <button id="gravity-button" class="control-button example-button">GRAVITY</button>
        <button id="gravity-button-2" class="control-button example-button">GRAVITY II</button>
        <button id="gravity-button-3" class="control-button example-button">GRAVITY III</button>
        <button id="gravity-button-4" class="control-button example-button">GRAVITY IV</button>
        <button id="charge-button" style="display: none" class="control-button example-button">CHARGE</button>
        <button id="egg-button" style="display: none" class="control-button example-button">EGG</button>
        <button id="balloon-button" style="display: none" class="control-button example-button">BALLOON</button>
        <button id="wind-button" class="control-button example-button">WIND</button>
        <button id="paint-button" class="control-button example-button">PAINT</button>
        <button id="chase-button" class="control-button example-button">CHASE</button>
        <button id="coins-button" class="control-button example-button">COINS</button>
        
        <button id="count-button-1" class="control-button example-button">COUNT I</button>
        <button id="count-button-2" class="control-button example-button">COUNT II</button>
        <button id="count-button-3" class="control-button example-button">COUNT III </button>
        <button id="count-button-4" class="control-button example-button">COUNT IV</button>
        <button id="count-button-5" class="control-button example-button">COUNT V</button>

        <button id="arc-slack-button" style="display: none" class="control-button example-button">ARC SLACK</button>
        <button id="rink-button" style="display: none" class="control-button example-button">ICE RINK</button>
        <button id="double-count-button" class="control-button example-button">DOUBLE COUNT I</button>
        <button id="double-count-2-button" class="control-button example-button">DOUBLE COUNT II</button>
        <button id="swap-button" style="display: none" class="control-button example-button">SWAP</button>
        <button id="disease-2-button" style="display: none" class="control-button example-button">DISEASE II</button>
        <button id="jump-button" style="display: none" class="control-button example-button">JUMP</button>
        <button id="bullets-button" class="control-button example-button">BULLETS</button>
        <button id="levels-button" style="display: none" class="control-button example-button">LEVELS</button>
        <button id="random-button" style="display: none" style="background-color: orange !important" class="control-button example-button">RANDOM SCENE</button>
        <button id="random-button-2" style="background-color: orange !important" class="control-button example-button">RANDOM PROGRAM</button>
        <button id="random-button-3" style="background-color: orange !important" class="control-button example-button">RANDOM GROUPED PROGRAM</button>
        <button id="synthesize-button" style="display: none" style="background-color: #69e8e8 !important;" class="control-button example-button disabled">SYNTHESIZE</button>
      </div>
      <div id="container">
        <div class="grid-container" >
          <div class="grid" style="grid-template-columns: repeat($(floor(Int64, sqrt(length(size)))), 25px); grid-template-rows: repeat($(floor(Int64, sqrt(length(size)))), 25px);">
            <% @foreach(size) do s %>
                   <button class="cell" id="$(s)" type="submit">
                   </button>
            <% end %>
          </div>
          <div style="display: flex; margin-top: 10px;">
              <button id="play-button" class="control-button" type="submit" id="run" style="margin-right: 10px;">▶</button>
              <button id="restart-button" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;">↻</button>
              <button id="save-button" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;"><i class="fa fa-floppy-o" aria-hidden="true"></i></button>
              <button id="history-button" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;"><i class="fa fa-history" aria-hidden="true"></i></button>
              <button id="toggle-button" class="control-button">TOGGLE</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    //const host = "http://www.logic.toys"; 
    const host = "http://localhost:8000";
    // const host = "https://840a-129-236-162-16.ngrok.io"
    // const host = "http://9a3e0fec8d4c.ngrok.io";
    document.addEventListener("DOMContentLoaded", function() {
      // global frontend variables
      var not_run_yet = true;
      var intervalID = -1;
      var timestep = 300; // 1200000; // 300 // 5000
      var historytimestep = 300;
      var compiled = false;
      var client_id = getRandomInt(1, 10000);
      console.log("client_id: "+client_id);
      var grid_size = [16, 16];
      var model_name = "";
      var saved = false;
      var history_mode = false;
      var historyIntervalID = -1;
      var history_response = '{}';
      var history_index = -1;
      var paused = false;
  
      // attach event listeners to buttons
      Array.from(document.getElementsByClassName("cell")).forEach(function (cell) {
        //console.log(cell.id)
        cell.addEventListener("click", function () { click(parseInt(cell.id)); });
      })
      document.getElementById("play-button").addEventListener("click", playOrPauseClick);
      document.getElementById("restart-button").addEventListener("click", restartClick);
      document.getElementById("compile-button").addEventListener("click", compileClick);
      document.getElementById("particles-button").addEventListener("click", particlesClick);
      document.getElementById("ants-button").addEventListener("click", antsClick);
      document.getElementById("light-button").addEventListener("click", lightClick);
      document.getElementById("magnets-button").addEventListener("click", magnetsClick);
      document.getElementById("tetris-button").addEventListener("click", tetrisClick);
      document.getElementById("plug-button").addEventListener("click", plugClick);
      document.getElementById("ice-button").addEventListener("click", iceClick);
      document.getElementById("hatch-button").addEventListener("click", hatchClick);
      document.getElementById("snake-button").addEventListener("click", snakeClick);
      document.getElementById("magnets-button-2").addEventListener("click", magnets2Click);
      document.getElementById("magnets-button-3").addEventListener("click", magnets3Click);
      document.getElementById("lock-button").addEventListener("click", lockClick);
      document.getElementById("bbq-button").addEventListener("click", bbqClick);
      document.getElementById("bottle-button").addEventListener("click", bottleClick);
      document.getElementById("disease-button").addEventListener("click", diseaseClick);
      document.getElementById("balls-button-1").addEventListener("click", balls1Click);
      document.getElementById("balls-button-2").addEventListener("click", balls2Click);
      document.getElementById("space-button").addEventListener("click", spaceInvadersClick);
      document.getElementById("gol-button").addEventListener("click", gameOfLifeClick);
      document.getElementById("sokoban-button").addEventListener("click", sokobanClick);
      document.getElementById("sokoban-button-2").addEventListener("click", sokobanClick2);
      document.getElementById("grow-button").addEventListener("click", growClick);
      document.getElementById("mario-button").addEventListener("click", marioClick);
      document.getElementById("sand-button").addEventListener("click", sandClick);
      document.getElementById("gravity-button").addEventListener("click", gravityClick);
      document.getElementById("gravity-button-2").addEventListener("click", gravity2Click);
      document.getElementById("gravity-button-3").addEventListener("click", gravity3Click);
      document.getElementById("gravity-button-4").addEventListener("click", gravity4Click);
      document.getElementById("charge-button").addEventListener("click", chargeClick);
      document.getElementById("egg-button").addEventListener("click", eggClick);
      document.getElementById("balloon-button").addEventListener("click", balloonClick);
      document.getElementById("wind-button").addEventListener("click", windClick);
      document.getElementById("paint-button").addEventListener("click", paintClick);
      document.getElementById("chase-button").addEventListener("click", chaseClick);
      document.getElementById("coins-button").addEventListener("click", coinsClick);

      document.getElementById("count-button-1").addEventListener("click", count1Click);
      document.getElementById("count-button-2").addEventListener("click", count2Click);
      document.getElementById("count-button-3").addEventListener("click", count3Click);
      document.getElementById("count-button-4").addEventListener("click", count4Click);
      document.getElementById("count-button-5").addEventListener("click", count5Click);

      document.getElementById("arc-slack-button").addEventListener("click", arcSlackClick);
      document.getElementById("rink-button").addEventListener("click", rinkClick);
      document.getElementById("double-count-button").addEventListener("click", doubleCountClick);
      document.getElementById("double-count-2-button").addEventListener("click", doubleCount2Click);
      document.getElementById("swap-button").addEventListener("click", swapClick);
      document.getElementById("disease-2-button").addEventListener("click", disease2Click);
      document.getElementById("jump-button").addEventListener("click", jumpClick);
      document.getElementById("bullets-button").addEventListener("click", bulletsClick);
      document.getElementById("levels-button").addEventListener("click", levelsClick);
      document.getElementById("toggle-button").addEventListener("click", toggleClick);
      document.getElementById("random-button").addEventListener("click", randomClick);
      document.getElementById("random-button-2").addEventListener("click", randomClick2);
      document.getElementById("random-button-3").addEventListener("click", randomClick3);
      document.getElementById("synthesize-button").addEventListener("click", synthesizeClick);


      document.getElementById("history-button").addEventListener("click", historyClick);
      document.getElementById("save-button").addEventListener("click", saveClick);

      // assign button styles
      updateButtonStyles();

      function updateButtonStyles() {
        compileButton = document.getElementById("compile-button");
        antsButton = document.getElementById("ants-button");
        particlesButton = document.getElementById("particles-button");
        lightButton = document.getElementById("light-button");
        magnetsButton = document.getElementById("magnets-button");
        plugButton = document.getElementById("plug-button");
        iceButton = document.getElementById("ice-button");
        tetrisButton = document.getElementById("tetris-button");
        hatchButton = document.getElementById("hatch-button");
        snakeButton = document.getElementById("snake-button");
        magnets2Button = document.getElementById("magnets-button-2");
        magnets3Button = document.getElementById("magnets-button-3");
        lockButton = document.getElementById("lock-button");
        bbqButton = document.getElementById("bbq-button");
        bottleButton = document.getElementById("bottle-button");
        diseaseButton = document.getElementById("disease-button");
        balls1Button = document.getElementById("balls-button-1");
        balls2Button = document.getElementById("balls-button-2");
        spaceButton = document.getElementById("space-button");
        golButton = document.getElementById("gol-button");
        sokobanButton = document.getElementById("sokoban-button");
        sokoban2Button = document.getElementById("sokoban-button-2");
        growButton = document.getElementById("grow-button");
        marioButton = document.getElementById("mario-button");
        sandButton = document.getElementById("sand-button");
        gravityButton = document.getElementById("gravity-button");
        gravity2Button = document.getElementById("gravity-button-2");
        gravity3Button = document.getElementById("gravity-button-3");
        gravity4Button = document.getElementById("gravity-button-4");
        chargeButton = document.getElementById("charge-button");
        eggButton = document.getElementById("egg-button");
        balloonButton = document.getElementById("balloon-button");
        windButton = document.getElementById("wind-button");
        paintButton = document.getElementById("paint-button");
        chaseButton = document.getElementById("chase-button");
        coinsButton = document.getElementById("coins-button");
        
        count1Button = document.getElementById("count-button-1");
        count2Button = document.getElementById("count-button-2");
        count3Button = document.getElementById("count-button-3");
        count4Button = document.getElementById("count-button-4");
        count5Button = document.getElementById("count-button-5");

        arcSlackButton = document.getElementById("arc-slack-button");
        rinkButton = document.getElementById("rink-button");
        doubleCountButton = document.getElementById("double-count-button");
        doubleCount2Button = document.getElementById("double-count-2-button");
        swapButton = document.getElementById("swap-button");
        disease2Button = document.getElementById("disease-2-button");
        jumpButton = document.getElementById("jump-button");
        bulletsButton = document.getElementById("bullets-button");
        levelsButton = document.getElementById("levels-button");
        randomButton = document.getElementById("random-button");
        randomButton2 = document.getElementById("random-button-2");
        randomButton3 = document.getElementById("random-button-3");
        synthesizeButton = document.getElementById("synthesize-button");

        playButton = document.getElementById("play-button");
        restartButton = document.getElementById("restart-button");
        saveButton = document.getElementById("save-button");
        historyButton = document.getElementById("history-button");
        toggleButton = document.getElementById("toggle-button");

        if (saved) {
          saveButton.classList.add("disabled");
        } else {
          saveButton.classList.remove("disabled");
        }

        if (compiled) {
          compileButton.innerHTML = "RESET <i style='font-size: medium' class='fa fa-code' aria-hidden='true'></i>";
          playButton.style.display = "";
          restartButton.style.display = "";
          saveButton.style.display = "";
          historyButton.style.display = "";

          antsButton.classList.add("disabled");
          particlesButton.classList.add("disabled");
          lightButton.classList.add("disabled");
          magnetsButton.classList.add("disabled");
          magnets2Button.classList.add("disabled");
          magnets3Button.classList.add("disabled");
          lockButton.classList.add("disabled");
          bbqButton.classList.add("disabled");
          bottleButton.classList.add("disabled");
          diseaseButton.classList.add("disabled");
          balls1Button.classList.add("disabled");
          balls2Button.classList.add("disabled");
          spaceButton.classList.add("disabled");
          golButton.classList.add("disabled");
          sokobanButton.classList.add("disabled");
          sokoban2Button.classList.add("disabled");
          growButton.classList.add("disabled");
          marioButton.classList.add("disabled");
          sandButton.classList.add("disabled");
          gravityButton.classList.add("disabled");
          gravity2Button.classList.add("disabled");
          gravity3Button.classList.add("disabled");
          gravity4Button.classList.add("disabled");
          chargeButton.classList.add("disabled");
          eggButton.classList.add("disabled");
          balloonButton.classList.add("disabled");
          windButton.classList.add("disabled");
          paintButton.classList.add("disabled");
          chaseButton.classList.add("disabled");
          coinsButton.classList.add("disabled");

          count1Button.classList.add("disabled");
          count2Button.classList.add("disabled");
          count3Button.classList.add("disabled");
          count4Button.classList.add("disabled");
          count5Button.classList.add("disabled");
          
          arcSlackButton.classList.add("disabled");
          rinkButton.classList.add("disabled");
          doubleCountButton.classList.add("disabled");
          doubleCount2Button.classList.add("disabled");
          swapButton.classList.add("disabled");
          disease2Button.classList.add("disabled");
          jumpButton.classList.add("disabled");
          bulletsButton.classList.add("disabled");
          levelsButton.classList.add("disabled");
          plugButton.classList.add("disabled");
          iceButton.classList.add("disabled");
          tetrisButton.classList.add("disabled");
          hatchButton.classList.add("disabled");
          snakeButton.classList.add("disabled");
          randomButton.classList.add("disabled");
          randomButton2.classList.add("disabled");
          randomButton3.classList.add("disabled");
          
          if (!history_mode) {
            playButton.classList.remove("history-mode");
            restartButton.classList.remove("history-mode");
            saveButton.classList.remove("history-mode");
            historyButton.classList.remove("history-mode");
            compileButton.classList.remove("history-mode");
            toggleButton.classList.remove("history-mode");

            playButton.classList.remove("disabled");
            if (intervalID == -1) {
              compileButton.classList.remove("disabled");
              synthesizeButton.classList.remove("disabled");
              playButton.innerText = "▶";
              playButton.style.fontSize = "13px";
              if (not_run_yet) {
                restartButton.classList.add("disabled");
                saveButton.classList.add("disabled");
                historyButton.classList.add("disabled");
              } else {
                restartButton.classList.remove("disabled");
                saveButton.classList.remove("disabled");
                historyButton.classList.remove("disabled");
              }
            } else {
              compileButton.classList.add("disabled");
              synthesizeButton.classList.add("disabled");
              playButton.innerText = "▌▌";
              playButton.style.fontSize = "9px";
              restartButton.classList.add("disabled");
              saveButton.classList.add("disabled");
              historyButton.classList.add("disabled");
            }
          } else {
            playButton.classList.add("history-mode");
            restartButton.classList.add("history-mode");
            saveButton.classList.add("history-mode");
            historyButton.classList.add("history-mode");
            compileButton.classList.add("history-mode");
            toggleButton.classList.remove("history-mode");

            if (historyIntervalID == -1) {
              console.log("updateButtonStyles historyIntervalID == -1");
              if (history_index < Object.keys(JSON.parse(history_response)).length) {
                console.log("here 1");
                playButton.classList.remove("disabled");
              } else {
                console.log("here 2");
                playButton.classList.add("disabled");
              }
              playButton.innerText = "▶";
              playButton.style.fontSize = "13px";
              restartButton.classList.remove("disabled");
              saveButton.classList.remove("disabled");
              historyButton.classList.remove("disabled");
              compileButton.classList.remove("disabled");
            } else {
              playButton.innerText = "▌▌";
              playButton.style.fontSize = "9px";
              playButton.classList.remove("disabled");
              restartButton.classList.add("disabled");
              saveButton.classList.add("disabled");
              historyButton.classList.add("disabled");
              compileButton.classList.add("disabled");
            }
          }
        } else {
          compileButton.classList.remove("history-mode")
          compileButton.innerHTML = "COMPILE <i style='font-size: medium' class='fa fa-code' aria-hidden='true'></i>"; // 
          playButton.style.display = "none";
          restartButton.style.display = "none";
          saveButton.style.display = "none";
          historyButton.style.display = "none";

          antsButton.classList.remove("disabled");
          particlesButton.classList.remove("disabled");
          lightButton.classList.remove("disabled");
          magnetsButton.classList.remove("disabled"); 
          magnets2Button.classList.remove("disabled");
          magnets3Button.classList.remove("disabled");
          lockButton.classList.remove("disabled");
          bbqButton.classList.remove("disabled");
          bottleButton.classList.remove("disabled");
          diseaseButton.classList.remove("disabled");
          balls1Button.classList.remove("disabled");
          balls2Button.classList.remove("disabled");
          spaceButton.classList.remove("disabled");
          golButton.classList.remove("disabled");
          sokobanButton.classList.remove("disabled");
          sokoban2Button.classList.remove("disabled");
          growButton.classList.remove("disabled");
          marioButton.classList.remove("disabled");
          sandButton.classList.remove("disabled");
          gravityButton.classList.remove("disabled");
          gravity2Button.classList.remove("disabled");
          gravity3Button.classList.remove("disabled");
          gravity4Button.classList.remove("disabled");
          chargeButton.classList.remove("disabled");
          eggButton.classList.remove("disabled");
          balloonButton.classList.remove("disabled");
          windButton.classList.remove("disabled");
          paintButton.classList.remove("disabled");
          chaseButton.classList.remove("disabled");
          coinsButton.classList.remove("disabled");

          count1Button.classList.remove("disabled");
          count2Button.classList.remove("disabled");
          count3Button.classList.remove("disabled");
          count4Button.classList.remove("disabled");
          count5Button.classList.remove("disabled");

          arcSlackButton.classList.remove("disabled");
          rinkButton.classList.remove("disabled");
          doubleCountButton.classList.remove("disabled");
          doubleCount2Button.classList.remove("disabled");
          swapButton.classList.remove("disabled");
          disease2Button.classList.remove("disabled");
          jumpButton.classList.remove("disabled");
          bulletsButton.classList.remove("disabled");
          levelsButton.classList.remove("disabled");
          tetrisButton.classList.remove("disabled");
          hatchButton.classList.remove("disabled");
          snakeButton.classList.remove("disabled");
          plugButton.classList.remove("disabled");
          iceButton.classList.remove("disabled");
          randomButton.classList.remove("disabled");
          randomButton2.classList.remove("disabled");
          randomButton3.classList.remove("disabled");
          synthesizeButton.classList.add("disabled");
        }
      }

      function updateCellStyles(xml_response) { 
        console.log("updateCellStyles")
        console.log(xml_response);
        xml_json = JSON.parse(xml_response);
        Array.from(document.getElementsByClassName("cell")).forEach(function (cell) { 
          cell.style.background = xml_json[0] == "#ffffff00" ? xml_json[0] : "linear-gradient(45deg, "+colorToRGBA(xml_json[0], 0.6)+", "+colorToRGBA(xml_json[0], 0.6)+")"
        })
        xml_json.slice(1, xml_json.length).forEach(function (particle) {
          if ((particle[1] < grid_size[1] && particle[1] >= 0) && (particle[0] < grid_size[0] && particle[0] >= 0)) {
            cell = document.getElementById((particle[1]*grid_size[0] + particle[0]).toString())
            cell.style.background = cell.style.background != "linear-gradient(45deg, "+colorToRGBA(xml_json[0], 0.6)+", "+colorToRGBA(xml_json[0], 0.6)+")" ? 
            ["linear-gradient(45deg, "+colorToRGBA(particle[2], 0.6)+", "+colorToRGBA(particle[2], 0.6)+")", cell.style.background].join(", ") : "linear-gradient(45deg, "+colorToRGBA(particle[2], 0.6)+", "+colorToRGBA(particle[2], 0.6)+")";
          }
        })
      } 

      function compileClick() {
        history_mode = false;  
        saved = false;

        console.log("compileClick")
        var xhr = new XMLHttpRequest(); 
        xhr.open("POST", host + '/compileautumn', true);

        //Send the proper header information along with the request
        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === 4 && this.status === 200) {
            content = JSON.parse(xhr.response)[0];
            console.log("content: "+content);

            if (content == "") {
              compiled = false;
              not_run_yet = true;
              myCodeMirror.setOption("readOnly", false);
              // particlesClick();
              // reset grid
              grid_size = [16, 16]
              Array.from(document.getElementsByClassName("grid")).forEach(function (grid) {
                grid.innerHTML = "";
                grid.style = "grid-template-columns: repeat("+grid_size[0]+", 25px); grid-template-rows: repeat("+grid_size[1]+", 25px);"
                for (i=0; i < grid_size[0]*grid_size[1]; i++) {
                  const button = document.createElement("button")
                  button.classList.add("cell");
                  button.id = i.toString();
                  button.padding = "12px"
                  button.width = "0px"
                  button.height = "0px"
                  button.onclick = function() { console.log(button.id); click(parseInt(button.id));};
                  grid.appendChild(button);
                }
              });
              Array.from(document.getElementsByClassName("cell")).forEach(function (cell) { cell.style.background = ""})

            } else { 
              compiled = true;
              myCodeMirror.setOption("readOnly", "nocursor");
              myCodeMirror.setValue(content);
            }
            updateButtonStyles(); 
          }
        };
        if (!compiled) {
          console.log("hello");
          document.getElementById("compile-button").innerHTML = "COMPILING...";
        }
        console.log("client_id: "+client_id);
        console.log("autumn-string: "+myCodeMirror.getValue());
        formData = new FormData();
        formData.append("autumnstring", compiled ? "" : myCodeMirror.getValue());
        formData.append("clientid", client_id);
        xhr.send(formData);
      }

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
      }

      function playOrPauseClick() {
        console.log("playOrPauseClick");
        if (!history_mode) {
          if (intervalID !== -1) { // pause
            paused = true;
            clearInterval(intervalID);
            intervalID = -1;
            updateButtonStyles();
          } else { // play
            if (not_run_yet) {
              var xhr = new XMLHttpRequest();
              xhr.open("GET", host + '/startautumn?clientid='+client_id, true);
      
              //Send the proper header information along with the request
              xhr.setRequestHeader("Content-Type", "application/json");
      
              xhr.onreadystatechange = function () { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    // Request finished. Do processing here.
                    console.log("success!");
                    console.log("xhr.response: "+JSON.stringify(xhr.response));
                    const xhr_json = JSON.parse(xhr.response)
                    // update grid
                    grid_size = xhr_json[0]
                    console.log("grid_size")
                    console.log(grid_size)
                    console.log(typeof(grid_size))

                    cell_size = 25;
                    if (Math.max(grid_size[0], grid_size[1]) > 18) {
                      cell_size = Math.round(cell_size * 18/Math.max(grid_size[0], grid_size[1]))
                    }

                    Array.from(document.getElementsByClassName("grid")).forEach(function (grid) {
                      grid.innerHTML = "";
                      grid.style = "grid-template-columns: repeat("+grid_size[0]+", "+ cell_size +"px); grid-template-rows: repeat("+grid_size[1]+", " + cell_size + "px);"
                      for (i=0; i < grid_size[0]*grid_size[1]; i++) {
                        const button = document.createElement("button")
                        button.classList.add("cell");
                        button.id = i.toString();
                        button.width = "0px"
                        button.height = "0px"
                        button.padding = Math.round(Math.max(cell_size/2 - 1, 1)).toString() + "px"
                        button.onclick = function() { console.log(button.id); click(parseInt(button.id));};
                        grid.appendChild(button);
                      }
                    });
                    paused = false;
                    if (intervalID != -1) {
                      clearInterval(intervalID);
                    }
                    updateCellStyles(JSON.stringify(xhr_json.slice(1,xhr_json.length)));
                    intervalID = setInterval(step, timestep);
                    updateButtonStyles();
                    console.log("here?");
                }
              };
              console.log("hello");
              document.getElementById("play-button").innerHTML = "<i style='font-size: medium' class='fa fa-spinner fa-spin'></i>";
              not_run_yet = false;
              xhr.send();
            } else {
              paused = false;
              intervalID = setInterval(step, timestep);
              updateButtonStyles();
            }
          }
        } else {
          if (historyIntervalID == -1) {
            historyIntervalID = setInterval(historyStep, historytimestep);
          } else {
            clearInterval(historyIntervalID);
            historyIntervalID = -1;
          }
          updateButtonStyles();
        }

      }

      function restartClick() {
        if (!history_mode) {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", host + '/startautumn?clientid='+client_id, true);

          //Send the proper header information along with the request
          xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onreadystatechange = function () { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                // Request finished. Do processing here.
                if (intervalID != -1) {
                  clearInterval(intervalID);
                }
                //updateCellStyles(`["#ffffff00"]`);
                paused = false;
                intervalID = setInterval(step, timestep);
                updateButtonStyles();
            }
          };
          xhr.send();
        } else {
          history_index = 0;
          historyIntervalID = setInterval(historyStep, historytimestep);
          updateButtonStyles();
        }
      }
      

      function click(id) {
        if (!history_mode) {
          if (intervalID != -1) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", host + '/clicked?x='+(id % grid_size[0])+'&y='+Math.floor(id/grid_size[0])+'&clientid='+client_id, true);

            //Send the proper header information along with the request
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () { // Call a function when the state changes.
              if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                  // Request finished. Do processing here.
                  updateCellStyles(xhr.response);
              }
            };
            xhr.send();
          }
        }
      }

      document.addEventListener('keyup', function(event) {
        if (!history_mode && (intervalID != -1)) {
          var xhr = new XMLHttpRequest();
          let key = "";
          switch (event.key) {
            case "ArrowLeft":
              key = "left";
              break;
            case "ArrowRight":
              key = "right";
              break;
            case "ArrowUp":
              key = "up";
              break;
            case "ArrowDown":
              key = "down";
              break; 
          }
          xhr.open("GET", host + '/' + key + '?clientid='+client_id, true);

          //Send the proper header information along with the request
          xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onreadystatechange = function () { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                // Request finished. Do processing here.
                updateCellStyles(xhr.response);
            }
          };
          xhr.send();          
        }
      });

      

      function step() {
        console.log("step");
        var xhr = new XMLHttpRequest();

        xhr.open("GET", host + '/step?clientid='+client_id, true);

        //Send the proper header information along with the request
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
              // Request finished. Do processing here.
              console.log("success!");
              console.log("xhr.response: "+JSON.stringify(xhr.response));
              console.log(typeof(JSON.parse(xhr.response)))

              updateCellStyles(xhr.response);
              clearInterval(intervalID);
              if (paused) {
                intervalID = -1;
              } else {
                intervalID = setInterval(step, timestep);
              }
          }
        };
        xhr.send();
      }

      function saveClick() {
        history_mode = true;
        saved = false;
        if (history_mode && !(saved)) {
          var xhr = new XMLHttpRequest();

          xhr.open("GET", host + '/save?clientid='+client_id+"&model="+model_name+"&gridsize="+grid_size[0], true);
            //Send the proper header information along with the request
            xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onreadystatechange = function () { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
              // Request finished. Do processing here.
              console.log("success!");
              console.log("xhr.response: "+JSON.stringify(xhr.response));
              saved = true;
              history_mode = false;
              updateButtonStyles();
            }
          };
          xhr.send();
          
        }
      }

      function historyClick() {
        if (!history_mode) {
          history_mode = true;
          var xhr = new XMLHttpRequest();

          xhr.open("GET", host + '/replay?clientid='+client_id, true);
                  //Send the proper header information along with the request
                  xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onreadystatechange = function () { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                // Request finished. Do processing here.
                console.log("success!");
                console.log("xhr.response: "+JSON.stringify(xhr.response));

                history_response = xhr.response;
                history_index = 0;
                historyIntervalID = setInterval(historyStep, historytimestep);
                updateButtonStyles();
            }
          };
          xhr.send();

        } else {
          history_mode = false;
          history_response = '{}';
          updateButtonStyles();
          updateCellStyles(`["#ffffff00"]`);
        }

      }

      function historyStep() {
        if (history_index < Object.keys(JSON.parse(history_response)).length) {
          console.log(history_response);
          console.log(JSON.parse(history_response)[history_index])
          ret_val = JSON.parse(history_response)[history_index]
          console.log("here: history_index")
          console.log(history_index)
          console.log("here: ret_val")
          console.log(JSON.stringify(ret_val))
          updateCellStyles(JSON.stringify(ret_val));
          history_index++;
        } else {
          clearInterval(historyIntervalID);
          historyIntervalID = -1;
          updateButtonStyles();
        }
      }

      var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("autumn-string"), { mode : "erlang",
                                                                                            theme : "erlang-dark",                                                                                              
                                                                                            lineNumbers: true,
                                                                                            viewportMargin: 0,
                                                                                            autoCloseBrackets: true,
                                                                                            matchBrackets: true,
                                                                                            scrollbarStyle: "overlay",
                                                                                            styleActiveLine: {nonEmpty: true},
                                                                                            });
      particlesClick();

    updateCellStyles(`["#ffffff00"]`);

    function colorToRGBA(color, a) {
      //console.log("colorToRGBA")
      //console.log(color);
      if (color[0] != "#") {
        hex = colors[color];
      } else {
        hex = color;
      }
      // console.log("hex: "+hex)
      return hexToRGB(hex, a)
    }

    function hexToRGB(hex, alpha) {
      var r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);

      if (alpha) {
          return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
      } else {
          return "rgb(" + r + ", " + g + ", " + b + ")";
      }
    }

    var colors = {"aliceblue":"#f0f8ff","antiquewhite":"#faebd7","aqua":"#00ffff","aquamarine":"#7fffd4","azure":"#f0ffff",
      "beige":"#f5f5dc","bisque":"#ffe4c4","black":"#000000","blanchedalmond":"#ffebcd","blue":"#0000ff","blueviolet":"#8a2be2","brown":"#a52a2a","burlywood":"#deb887",
      "cadetblue":"#5f9ea0","chartreuse":"#7fff00","chocolate":"#d2691e","coral":"#ff7f50","cornflowerblue":"#6495ed","cornsilk":"#fff8dc","crimson":"#dc143c","cyan":"#00ffff",
      "darkblue":"#00008b","darkcyan":"#008b8b","darkgoldenrod":"#b8860b","darkgray":"#a9a9a9","darkgreen":"#006400","darkkhaki":"#bdb76b","darkmagenta":"#8b008b","darkolivegreen":"#556b2f",
      "darkorange":"#ff8c00","darkorchid":"#9932cc","darkred":"#8b0000","darksalmon":"#e9967a","darkseagreen":"#8fbc8f","darkslateblue":"#483d8b","darkslategray":"#2f4f4f","darkturquoise":"#00ced1",
      "darkviolet":"#9400d3","deeppink":"#ff1493","deepskyblue":"#00bfff","dimgray":"#696969","dodgerblue":"#1e90ff",
      "firebrick":"#b22222","floralwhite":"#fffaf0","forestgreen":"#228b22","fuchsia":"#ff00ff",
      "gainsboro":"#dcdcdc","ghostwhite":"#f8f8ff","gold":"#ffd700","goldenrod":"#daa520","gray":"#808080","green":"#008000","greenyellow":"#adff2f",
      "honeydew":"#f0fff0","hotpink":"#ff69b4",
      "indianred ":"#cd5c5c","indigo":"#4b0082","ivory":"#fffff0","khaki":"#f0e68c",
      "lavender":"#e6e6fa","lavenderblush":"#fff0f5","lawngreen":"#7cfc00","lemonchiffon":"#fffacd","lightblue":"#add8e6","lightcoral":"#f08080","lightcyan":"#e0ffff","lightgoldenrodyellow":"#fafad2",
      "lightgrey":"#d3d3d3","lightgreen":"#90ee90","lightpink":"#ffb6c1","lightsalmon":"#ffa07a","lightseagreen":"#20b2aa","lightskyblue":"#87cefa","lightslategray":"#778899","lightsteelblue":"#b0c4de",
      "lightyellow":"#ffffe0","lime":"#00ff00","limegreen":"#32cd32","linen":"#faf0e6",
      "magenta":"#ff00ff","maroon":"#800000","mediumaquamarine":"#66cdaa","mediumblue":"#0000cd","mediumorchid":"#ba55d3","mediumpurple":"#9370d8","mediumseagreen":"#3cb371","mediumslateblue":"#7b68ee",
      "mediumspringgreen":"#00fa9a","mediumturquoise":"#48d1cc","mediumvioletred":"#c71585","midnightblue":"#191970","mintcream":"#f5fffa","mistyrose":"#ffe4e1","moccasin":"#ffe4b5",
      "navajowhite":"#ffdead","navy":"#000080",
      "oldlace":"#fdf5e6","olive":"#808000","olivedrab":"#6b8e23","orange":"#ffa500","orangered":"#ff4500","orchid":"#da70d6",
      "palegoldenrod":"#eee8aa","palegreen":"#98fb98","paleturquoise":"#afeeee","palevioletred":"#d87093","papayawhip":"#ffefd5","peachpuff":"#ffdab9","peru":"#cd853f","pink":"#ffc0cb","plum":"#dda0dd","powderblue":"#b0e0e6","purple":"#800080",
      "rebeccapurple":"#663399","red":"#ff0000","rosybrown":"#bc8f8f","royalblue":"#4169e1",
      "saddlebrown":"#8b4513","salmon":"#fa8072","sandybrown":"#f4a460","seagreen":"#2e8b57","seashell":"#fff5ee","sienna":"#a0522d","silver":"#c0c0c0","skyblue":"#87ceeb","slateblue":"#6a5acd","slategray":"#708090","snow":"#fffafa","springgreen":"#00ff7f","steelblue":"#4682b4",
      "tan":"#d2b48c","teal":"#008080","thistle":"#d8bfd8","tomato":"#ff6347","turquoise":"#40e0d0",
      "violet":"#ee82ee",
      "wheat":"#f5deb3","white":"#ffffff","whitesmoke":"#f5f5f5",
      "yellow":"#ffff00","yellowgreen":"#9acd32"};

      function antsClick() {
        model_name = "ants";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Ant (Cell 0 0 "gray"))
(object Food (Cell 0 0 "red"))

(: ants (List Ant))
(= ants (initnext (list (Ant (Position 5 5)) (Ant (Position 1 14))) (prev ants)))

(: foods (List Food))
(= foods (initnext (list) (prev foods)))

(on true (= ants (updateObj (prev ants) (--> obj (move obj (unitVector obj (closest obj Food)))))))
(on true (= foods (updateObj (prev foods) (--> obj (if (intersects obj (prev ants))
                                                       then (removeObj obj)
                                                       else obj)))))

(on clicked (= foods (addObj foods (map Food (randomPositions GRID_SIZE 2)))))
)`);
    }

    function particlesClick() {
      model_name = "particles";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Particle (Cell 0 0 "blue"))

(: particles (List Particle))
(= particles 
  (initnext (list) 
            (updateObj (prev particles) (--> obj (uniformChoice (list (moveLeft obj) (moveRight obj) (moveDown obj) (moveUp obj)) ))))) 

(on clicked (= particles (addObj (prev particles) (Particle (Position (.. click x) (.. click y))))))
)`);
    }

    function lightClick() {
      model_name = "lights";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 10)

(object Light (: on Bool) (Cell 0 0 (if on then "yellow" else "white")))

(: lights (List Light))
(= lights (initnext (map (--> pos (Light false pos)) (filter (--> pos (== (.. pos x) (.. pos y))) (allPositions GRID_SIZE))) 
                    (prev lights)))

(on clicked (= lights (updateObj lights (--> obj (updateObj obj "on" (! (.. obj on)))))))
)`)
    }

    function magnetsClick() {
      model_name = "magnets_i";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Magnet (: color String) (list (Cell 0 0 color) (Cell 0 1 color)))

(: fixedMagnet Magnet)
(= fixedMagnet (initnext (Magnet "red" (Position 7 7)) (prev fixedMagnet)))

(: mobileMagnet Magnet)
(= mobileMagnet (initnext (Magnet "blue" (Position 4 7)) (prev mobileMagnet)))

(on left (= mobileMagnet (moveNoCollision (prev mobileMagnet) -1 0)))
(on right (= mobileMagnet (moveNoCollision (prev mobileMagnet) 1 0)))
(on up (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 -1)))
(on down (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 1)))
(on (adjacent (posPole mobileMagnet) (posPole fixedMagnet) 1) (= mobileMagnet (prev mobileMagnet)))
(on (adjacent (negPole mobileMagnet) (negPole fixedMagnet) 1) (= mobileMagnet (prev mobileMagnet)))
(on (in (displacement (posPole mobileMagnet) (negPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet    (unitVector (displacement (posPole mobileMagnet) (negPole fixedMagnet))))))
(on (in (displacement (negPole mobileMagnet) (posPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (displacement (negPole mobileMagnet) (posPole fixedMagnet))))))
  
(= posPole (fn (magnet) (first (render magnet))))  
(= negPole (fn (magnet) (last (render magnet))))  

(= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
)`);
    }

    function plugClick() {
      model_name = "plug";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Button (: color String) (Cell 0 0 color))
(object Vessel (Cell 0 0 "purple"))
(object Plug (Cell 0 0 "orange"))
(object Water (Cell 0 0 "blue"))

(: vesselButton Button)
(= vesselButton (Button "purple" (Position 2 0)))
(: plugButton Button)
(= plugButton (Button "orange" (Position 5 0)))
(: waterButton Button)
(= waterButton (Button "blue" (Position 8 0)))
(: removeButton Button)
(= removeButton (Button "black" (Position 11 0)))
(: clearButton Button)
(= clearButton (Button "red" (Position 14 0)))

(: vessels (List Vessel))
(= vessels (initnext (list (Vessel (Position 6 15)) (Vessel (Position 6 14)) (Vessel (Position 6 13)) (Vessel (Position 5 12)) (Vessel (Position 4 11)) (Vessel (Position 3 10)) (Vessel (Position 9 15)) (Vessel (Position 9 14)) (Vessel (Position 9 13)) (Vessel (Position 10 12)) (Vessel (Position 11 11)) (Vessel (Position 12 10))) (prev vessels)))
(: plugs (List Plug))
(= plugs (initnext (list (Plug (Position 7 15)) (Plug (Position 8 15)) (Plug (Position 7 14)) (Plug (Position 8 14)) (Plug (Position 7 13)) (Plug (Position 8 13))) (prev plugs)))
(: water (List Water))
(= water (initnext (list) (prev water)))

(= currentParticle (initnext "vessel" (prev currentParticle)))

(on true (= water (updateObj (prev water) (--> obj (nextLiquid obj)))))
(on (& clicked (& (isFree click) (== currentParticle "vessel"))) (= vessels (addObj vessels (Vessel (Position (.. click x) (.. click y))))))
(on (& clicked (& (isFree click) (== currentParticle "plug"))) (= plugs (addObj plugs (Plug (Position (.. click x) (.. click y))))))
(on (& clicked (& (isFree click) (== currentParticle "water"))) (= water (addObj water (Water (Position (.. click x) (.. click y))))))
(on (clicked vesselButton) (= currentParticle "vessel"))
(on (clicked plugButton) (= currentParticle "plug"))
(on (clicked waterButton) (= currentParticle "water"))
(on (clicked removeButton) (= plugs (removeObj plugs (--> obj true))))
(on (clicked clearButton) (let ((= vessels (removeObj vessels (--> obj true))) (= plugs (removeObj plugs (--> obj true))) (= water (removeObj water (--> obj true))))))  
)`);
    }

    function iceClick() {
      model_name = "ice";
      myCodeMirror.setValue(`(program
(= GRID_SIZE 8)
(object CelestialBody (: day Bool) (list (Cell 0 0 (if day then "gold" else "gray"))
                                        (Cell 0 1 (if day then "gold" else "gray"))
                                        (Cell 1 0 (if day then "gold" else "gray"))
                                        (Cell 1 1 (if day then "gold" else "gray"))))
(object Cloud (list (Cell -1 0 "gray")
                    (Cell 0 0 "gray")
                    (Cell 1 0 "gray")))

(object Water (: liquid Bool) (Cell 0 0 (if liquid then "blue" else "lightblue")))

(: celestialBody CelestialBody)
(= celestialBody (initnext (CelestialBody true (Position 0 0)) (prev celestialBody)))

(: cloud Cloud)
(= cloud (initnext (Cloud (Position 4 0)) (prev cloud)))

(: water (List Water))
(= water (initnext (list) (updateObj (prev water) nextWater)))

(on left (= cloud (nextCloud cloud (Position -1 0))))
(on right (= cloud (nextCloud cloud (Position 1 0))))
(on down (= water (addObj water (Water (.. celestialBody day) (move (.. cloud origin) (Position 0 1))))))
(on clicked (let ((= celestialBody (updateObj celestialBody "day" (! (.. celestialBody day)))) (= water (updateObj water (--> drop (updateObj drop "liquid" (! (.. drop liquid)))))))))

(= nextWater (fn (drop) 
                (if (.. drop liquid)
                  then (nextLiquid drop)
                  else (nextSolid drop))))

(= nextCloud (fn (cloud position)
                (if (isWithinBounds (move cloud position)) 
                  then (move cloud position)
                  else cloud)))
)`);
    }

  function tetrisClick() {
    model_name = "tetris";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  (object Tetris (: shape (List Cell)) shape)

  (: blocks (List Tetris))
  (= blocks (initnext (list) (nextBlocks (prev blocks) (prev activeTetris))))
  
  (: activeTetris Tetris)
  (= activeTetris (initnext (Tetris (list (Cell 0 0 "blue") (Cell 0 1 "blue") (Cell 0 2 "blue") (Cell 1 2 "blue")) 
                                    (uniformChoice (list (Position 4 0) (Position 7 0) (Position 10 0))))
                            (nextTetris (prev activeTetris))))
  
  (on up (= activeTetris (rotateNoCollision (prev activeTetris))))
  (on down (= activeTetris (rotateNoCollision (rotateNoCollision (rotateNoCollision (prev activeTetris))))))
  (on left (= activeTetris (moveNoCollision (prev activeTetris) (Position -1 0))))
  (on right (= activeTetris (moveNoCollision (prev activeTetris) (Position 1 0))))
  (on (== (.. (nextSolid (prev activeTetris)) origin) (.. (prev activeTetris) origin)) 
    (let ((= activeTetris (nextTetris (prev activeTetris))) (= blocks (nextBlocks (prev blocks) (prev activeTetris))))))
  
  (= nextBlocks (fn (blocks tetris) 
                    (if (& (isFree (Position 0 0) (Position 15 0) tetris) 
                             (== (.. (nextSolid tetris) origin) (.. tetris origin))) 
                    then (addObj blocks tetris) 
                    else blocks)))  

  (= nextTetris (fn (tetris) 
                    (if (isFree (Position 0 0) (Position 15 0) tetris) 
                     then 
                     (if (== (.. (nextSolid tetris) origin) (.. tetris origin)) 
                      then (Tetris (uniformChoice (list (list (Cell 0 0 "blue") (Cell 0 1 "blue") (Cell 0 2 "blue") (Cell 1 2 "blue"))
                                                        (list (Cell -1 0 "yellow") (Cell 0 0 "yellow") (Cell 0 1 "yellow") (Cell 1 0 "yellow"))
                                                        (list (Cell 0 0 "purple") (Cell 0 1 "purple") (Cell 1 0 "purple") (Cell 1 1 "purple"))
                                                        (list (Cell 0 0 "limegreen") (Cell 0 1 "limegreen") (Cell 1 1 "limegreen") (Cell 1 2 "limegreen")))) 
                                   (uniformChoice (list (Position 4 0) (Position 7 0) (Position 10 0)))) 
                      else (nextSolid tetris))
                    else (removeObj tetris))))
)`);
  }

  function hatchClick() {
    model_name = "egg";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Eggshell (: broken Bool) (Cell 0 0 "tan"))
  (object Feather (: color String) (Cell 0 0 color))


  (: eggshells (List Eggshell))
  (= eggshells (initnext egg (nextEggshells (prev eggshells) (prev feathers))))

  (: feathers (List Feather))
  (= feathers (initnext (updateObj chick (--> feather (updateObj feather "hidden" true))) (nextFeathers (prev feathers))))

  (on (clicked eggshells) (= eggshells (updateObj (prev eggshells) 
                                                  (--> eggshell 
                                                       (if (& (== (.. (.. eggshell origin) x) (.. click x)) (== (.. (.. eggshell origin) y) (.. click y))) 
                                                        then (updateObj eggshell "broken" true) 
                                                        else eggshell)))))
                       
  (= nextEggshells (fn (eggshells feathers) 
                       (updateObj eggshells (--> eggshell (if (.. eggshell broken)
                                                           then (if (intersects eggshell feathers) 
                                                                 then (removeObj eggshell) 
                                                                 else (nextLiquid eggshell))
                                                           else eggshell)))))

  (= nextFeathers (fn (feathers) 
                      (updateObj feathers (--> feather (if (& (isFree (.. feather origin) feather) (.. feather hidden)) 
                                                        then (updateObj feather "hidden" false)
                                                        else feather)))))

  (= egg (list                                    
         (Eggshell false (Position 7 15)) 
         (Eggshell false (Position 8 15))
         (Eggshell false (Position 9 15))  
         (Eggshell false (Position 6 14)) 
         (Eggshell false (Position 7 14)) 
         (Eggshell false (Position 8 14)) 
         (Eggshell false (Position 9 14))
         (Eggshell false (Position 10 14)) 
         (Eggshell false (Position 5 13)) 
         (Eggshell false (Position 6 13))
         (Eggshell false (Position 7 13)) 
         (Eggshell false (Position 8 13)) 
         (Eggshell false (Position 9 13)) 
         (Eggshell false (Position 10 13))
         (Eggshell false (Position 11 13)) 
         (Eggshell false (Position 5 12)) 
         (Eggshell false (Position 6 12)) 
         (Eggshell false (Position 7 12))
         (Eggshell false (Position 8 12)) 
         (Eggshell false (Position 9 12)) 
         (Eggshell false (Position 10 12)) 
         (Eggshell false (Position 11 12))
         (Eggshell false (Position 5 11)) 
         (Eggshell false (Position 6 11)) 
         (Eggshell false (Position 7 11)) 
         (Eggshell false (Position 8 11))
         (Eggshell false (Position 9 11)) 
         (Eggshell false (Position 10 11)) 
         (Eggshell false (Position 11 11)) 
         (Eggshell false (Position 6 10)) 
         (Eggshell false (Position 7 10)) 
         (Eggshell false (Position 8 10)) 
         (Eggshell false (Position 9 10))
         (Eggshell false (Position 10 10))
         (Eggshell false (Position 7 9)) 
         (Eggshell false (Position 8 9)) 
         (Eggshell false (Position 9 9))))

  (= chick (list (Feather "orange" (Position 7 15))
           (Feather "orange" (Position 8 15))
           (Feather "yellow" (Position 6 14))
           (Feather "yellow" (Position 7 14))
           (Feather "yellow" (Position 8 14))
           (Feather "yellow" (Position 9 14))
           (Feather "yellow" (Position 6 13))
           (Feather "yellow" (Position 7 13))
           (Feather "yellow" (Position 8 13))
           (Feather "yellow" (Position 9 13))
           (Feather "yellow" (Position 6 12))
           (Feather "yellow" (Position 7 12))
           (Feather "yellow" (Position 8 12))
           (Feather "yellow" (Position 9 12))
           (Feather "yellow" (Position 9 11))
           (Feather "yellow" (Position 10 11))
           (Feather "orange" (Position 11 11))
           (Feather "yellow" (Position 9 10))
           (Feather "black" (Position 10 10))))

)`);
  }

  function snakeClick() {
    model_name = "snake";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Snake (: head Cell) (: tail (List Cell)) (: direction Position) (list head tail))
  (object Food (Cell 0 0 "pink"))
  
  (: snake Snake)
  (= snake (initnext (Snake (Cell 7 7 "green") (list (Cell 8 7 "green")) (Position -1 0) (Position 0 0)) 
                     (nextSnake (prev snake) (prev food))))
  
  (: food Food)
  (= food (initnext (Food (Position 10 8)) (nextFood food)))
  
  (= nextSnake (fn (snake food) (let (
                                      (= new_snake (Snake (Cell (moveWrap (.. snake head) (.. snake direction)) "green") (vcat (.. snake head) (.. snake tail)) (.. snake direction) (.. snake origin)))
                    (if (in (.. new_snake head) (.. new_snake tail)) 
                                       then (Snake (Cell (.. (.. snake head) position) "red") (.. snake tail) (.. snake direction) (.. snake origin)) 
                                       else (if (! (isFree (.. food origin) food)) 
                                             then new_snake 
                                             else (updateObj new_snake "tail" (filter 
                                                                                (--> cell (!= (.. cell position) (.. (last (.. new_snake tail)) position))) 
                                            (.. new_snake tail)))))
                                     ))))
  
  (= nextFood (fn (food) (if (isFree (.. food origin) food) 
                          then food 
                          else (Food (uniformChoice (filter isFree (allPositions)))) )))
  
  (on left (= snake (if (== (.. (.. snake head) color) "red") then snake else (updateObj (prev snake) "direction" (Position -1 0)))))
  (on right (= snake (if (== (.. (.. snake head) color) "red") then snake else (updateObj (prev snake) "direction" (Position 1 0)))))
  (on up (= snake (if (== (.. (.. snake head) color) "red") then snake else (updateObj (prev snake) "direction" (Position 0 -1)))))
  (on down (= snake (if (== (.. (.. snake head) color) "red") then snake else (updateObj (prev snake) "direction" (Position 0 1)))))
)`);
  }

  function magnets2Click() {
    model_name = "magnets_ii";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Magnet (list (Cell 0 0 "blue") (Cell 0 1 "blue")))

  (: fixedMagnets (List Magnet))
  (= fixedMagnets (initnext (list (Magnet (Position 7 7))) (prev fixedMagnets)))

  (: mobileMagnet Magnet)
  (= mobileMagnet (initnext (Magnet (Position 4 7)) (prev mobileMagnet)))

  (on clicked (let ((= fixedMagnets (if (! (intersects (Magnet (Position (.. click x) (.. click y))))) then (addObj fixedMagnets mobileMagnet) else (prev fixedMagnets)))
                    (= mobileMagnet (if (! (intersects (Magnet (Position (.. click x) (.. click y))))) then (Magnet (Position (.. click x) (.. click y))) else (prev mobileMagnet)))
                   )))
  (on (clicked (prev mobileMagnet)) (= mobileMagnet (rotateNoCollision (prev mobileMagnet))))
  (on (clicked (prev fixedMagnets)) 
    (let ((= fixedMagnets (addObj fixedMagnets mobileMagnet)) 
          (= mobileMagnet (objClicked click fixedMagnets))
          (= fixedMagnets (removeObj fixedMagnets (objClicked click fixedMagnets)))
         )))
  (on left (= mobileMagnet (moveNoCollision (prev mobileMagnet) -1 0)))
  (on right (= mobileMagnet (moveNoCollision (prev mobileMagnet) 1 0)))
  (on up (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 -1)))
  (on down (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 1)))
  (on (adjacent (posPole mobileMagnet) (map posPole fixedMagnets)) (let ((= mobileMagnet (prev mobileMagnet)) (= fixedMagnets (prev fixedMagnets)))))
  (on (adjacent (negPole mobileMagnet) (map negPole fixedMagnets)) (let ((= mobileMagnet (prev mobileMagnet)) (= fixedMagnets (prev fixedMagnets)))))
  (on (intersects (map (--> magnet (displacement (posPole mobileMagnet) (negPole magnet))) fixedMagnets) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (uniformChoice (intersect (map (--> magnet (displacement (posPole mobileMagnet) (negPole magnet))) fixedMagnets) attractVectors))))))
  (on (intersects (map (--> magnet (displacement (negPole mobileMagnet) (posPole magnet))) fixedMagnets) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (uniformChoice (intersect (map (--> magnet (displacement (negPole mobileMagnet) (posPole magnet))) fixedMagnets) attractVectors))))))

  (= posPole (fn (magnet) (if (== (render magnet) (list)) then (Cell -1 -1 "blue") else (first (render magnet)))))  
  (= negPole (fn (magnet) (if (== (render magnet) (list)) then (Cell -1 -1 "blue") else (last (render magnet)))))  

  (= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
)`);
  }

  function magnets3Click() { 
    model_name = "magents_iii";
    myCodeMirror.setValue(`(program
    (= GRID_SIZE 16) 
  
  (object Magnet (list (Cell 0 0 "blue") (Cell 0 1 "blue")))
  
  (: fixedMagnet Magnet)
  (= fixedMagnet (initnext (Magnet (Position 7 7)) (prev fixedMagnet)))

  (: mobileMagnet Magnet)
  (= mobileMagnet (initnext (Magnet (Position 4 7)) (prev mobileMagnet)))
  
  (: isAttached Bool)
  (= isAttached (initnext false (prev isAttached)))
  
  (on clicked (= mobileMagnet (rotateNoCollision (prev mobileMagnet))))
  (on left (= mobileMagnet (move (prev mobileMagnet) -1 0))) 
  (on right (= mobileMagnet (move (prev mobileMagnet) 1 0)))
  (on up (= mobileMagnet (move (prev mobileMagnet) 0 -1)))
  (on down (= mobileMagnet (move (prev mobileMagnet) 0 1)))
  (on (& isAttached left) (= fixedMagnet (move (prev fixedMagnet) -1 0)))
  (on (& isAttached right) (= fixedMagnet (move (prev fixedMagnet) 1 0)))
  (on (& isAttached up) (= fixedMagnet (move (prev fixedMagnet) 0 -1)))
  (on (& isAttached down) (= fixedMagnet (move (prev fixedMagnet) 0 1)))
  (on (adjacent (posPole mobileMagnet) (posPole fixedMagnet)) (= mobileMagnet (prev mobileMagnet)))
  (on (adjacent (negPole mobileMagnet) (negPole fixedMagnet)) (= mobileMagnet (prev mobileMagnet)))
  (on (in (displacement (posPole mobileMagnet) (negPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet    (unitVector (displacement (posPole mobileMagnet) (negPole fixedMagnet))))))
  (on (in (displacement (negPole mobileMagnet) (posPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (displacement (negPole mobileMagnet) (posPole fixedMagnet))))))
  (on (& (adjacent (posPole mobileMagnet) (negPole fixedMagnet)) (adjacent (posPole fixedMagnet) (negPole mobileMagnet))) (= isAttached true))  
  
  (= posPole (fn (magnet) (first (render magnet))))  
  (= negPole (fn (magnet) (last (render magnet))))  

  (= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
)`);
  }

  function lockClick() { 
    model_name = "lock";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Key (list (Cell 0 0 "blue") (Cell 0 1 "blue")))
  (object Lock (list (Cell 0 0 "red") (Cell 0 1 "red") (Cell 0 2 "red") (Cell 0 3 "red") (Cell 1 2 "red") (Cell 1 3 "red") (Cell 2 0 "red") (Cell 2 1 "red") (Cell 2 2 "red") (Cell 2 3 "red")))
  (object Wall (list (Cell 0 0 "black") (Cell 1 0 "black") (Cell 2 0 "black") (Cell 3 0 "black") (Cell 4 0 "black")
  (Cell 5 0 "black") (Cell 6 0 "black") (Cell 7 0 "black") (Cell 8 0 "black") (Cell 9 0 "black")
  (Cell 10 0 "black") (Cell 11 0 "black") (Cell 12 0 "black")))

  (: fixedLock Lock)
  (= fixedLock (initnext (Lock (Position 0 7)) (prev fixedLock)))

  (: mobileKey Key)
  (= mobileKey (initnext (Key (Position 0 0)) (prev mobileKey)))

  (: movingWall Wall)
  (= movingWall (initnext (Wall (Position 3 7)) (prev movingWall)))

  (on left (= mobileKey (moveNoCollision (prev mobileKey) -1 0)))
  (on right (= mobileKey (moveNoCollision (prev mobileKey) 1 0)))
  (on up (= mobileKey (moveNoCollision (prev mobileKey) 0 -1)))
  (on down (= mobileKey (moveNoCollision (prev mobileKey) 0 1)))
  (on (& (== (.. mobileKey origin) (Position 1 7)) (!= (.. movingWall origin) (Position 4 7))) (= movingWall (move (prev movingWall) 1 0)))
  (on (& (!= (.. mobileKey origin) (Position 1 7)) (== (.. movingWall origin) (Position 4 7))) (= movingWall (move (prev movingWall) -1 0)))

)`);
  }

  function bbqClick() { 
    model_name = "bbq";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Bbq (: fire Bool) (: gas Integer) (list (Cell 0 1 "black") (Cell 1 1 "black") (Cell 2 1 "black") (Cell 1 0 (if fire then "orange" else "white")) (Cell 0 2 "gray") (Cell 0 3 "gray") (Cell 2 2 "gray") (Cell 2 3 "gray") (Cell 1 2 (if (> gas 20) then "yellow" else "white")) (Cell 1 3 (if (> gas 0) then "yellow" else "white"))))
  (object Person (: sick Bool) (Cell 0 0 (if sick then "green" else "blue")))
  (object Meat (: cooked Integer)  (Cell 0 0 (if (< cooked 15) then "pink" else (if (< cooked 30) then "brown" else "black"))))

  (object FillBBQ (Cell 0 0 "yellow"))

  (: bbq Bbq)
  (= bbq (initnext (Bbq true 28 (Position 7 12))
            (if (== (.. (prev bbq) gas) 0) then (updateObj (prev bbq) "fire" false) else
                  (if (.. (prev bbq) fire)
                    then (updateObj (prev bbq) "gas" (- (.. (prev bbq) gas) 1))
                    else (prev bbq)))))

  (: meat Meat)
  (= meat (initnext (Meat 0 (Position 8 11))
          (if (.. bbq fire)
            then (updateObj (prev meat) "cooked" (+ (.. (prev meat) cooked) 1))
            else (prev meat))))


  (: fillButton FillBBQ)
  (= fillButton (FillBBQ (Position 0 15)))

  (on (clicked bbq) (= bbq (if (== (.. (prev bbq) gas) 0) then (prev bbq) else (updateObj bbq "fire" (! (.. bbq fire))))))
  (on (clicked fillButton) (= bbq (updateObj bbq "gas" (+ (.. (prev bbq) gas) 5))))
)`);
  }

  function bottleClick() { 
    model_name = "bottle";
    myCodeMirror.setValue(`(program 
  (= GRID_SIZE 16)

  (object Suzie (Cell 0 0 "blue"))
  (object Billy (Cell 0 0 "red"))

  (object Bottle (: broken Bool) (list (Cell 0 0 (if broken then "yellow" else "white"))
                                        (Cell 0 1 (if broken then "white" else "yellow"))
                                        (Cell 0 2 (if broken then "gray" else "yellow"))
                                        (Cell 0 3 (if broken then "white" else "yellow"))
                                        (Cell 0 4 (if broken then "yellow" else "white"))))

  (object BottleSpot (Cell 0 0 "white"))
  (object Rock (Cell 0 0 "black"))

  (: suzie Suzie)
  (= suzie (Suzie (Position 0 0)))

  (: billy Billy)
  (= billy (Billy (Position 0 15)))

  (: bottleSpot BottleSpot)
  (= bottleSpot (initnext (BottleSpot (Position 15 7)) (BottleSpot (Position 15 7))))


  (: rocks (List Rock))
  (= rocks
    (initnext (list)
              (updateObj (prev rocks) (--> obj
                              (if (intersects bottleSpot obj) then (removeObj obj)
                                else (move obj (unitVector obj bottleSpot)))))))
  (= nextBottle (fn (bot rockst bottleSpott) (if (intersects bottleSpott rockst) then (updateObj bot "broken" true) else bot)))

  (: bottle Bottle)
  (= bottle (initnext (Bottle false (Position 15 5)) (nextBottle (prev bottle) (prev rocks) (prev bottleSpot))))

  (on (clicked suzie) (= rocks (addObj (prev rocks) (Rock (Position 0 0)))))
  (on (clicked billy) (= rocks (addObj (prev rocks) (Rock (Position 0 15)))))

  )`);
  }

  function diseaseClick() { 
    model_name = "disease";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 8)

(object Particle (: health Bool) (Cell 0 0 (if health then "gray" else "darkgreen")))

(: inactiveParticles (List Particle))
(= inactiveParticles (initnext (list (Particle true (Position 5 3)) (Particle true (Position 2 1)) (Particle true (Position 4 4)) (Particle true (Position 1 3)) )  
                    (updateObj (prev inactiveParticles) (--> obj (if true
                                                                  then (updateObj obj "health" false)
                                                                  else obj)) 
                                                        (--> obj (adj (prev obj) (filter (--> obj (! (.. (prev obj) health))) (vcat (list (prev activeParticle)) (prev inactiveParticles))) 1)))))   

(: activeParticle Particle)
(= activeParticle (initnext (Particle false (Position 0 0)) (prev activeParticle))) 

(on (!= (length (filter (--> obj (! (.. obj health))) (adjacentObjs activeParticle 1))) 0) (= activeParticle (updateObj (prev activeParticle) "health" false)))
(on (clicked (prev inactiveParticles)) 
    (let ((= inactiveParticles (addObj (prev inactiveParticles) (prev activeParticle))) 
          (= activeParticle (objClicked click (prev inactiveParticles)))
          (= inactiveParticles (removeObj inactiveParticles (objClicked click (prev inactiveParticles))))
        )))
(on left (= activeParticle (move (prev activeParticle) -1 0)))
(on right (= activeParticle (move (prev activeParticle) 1 0)))
(on up (= activeParticle (move (prev activeParticle) 0 -1)))
(on down (= activeParticle (move (prev activeParticle) 0 1)))
)`);
  }

  function balls1Click() { 
    model_name = "balls1";
    myCodeMirror.setValue(`(program 
  (= GRID_SIZE 16)

  (object Goal (Cell 0 0 "green"))
  (: goal Goal)
  (= goal (initnext (Goal (Position 0 10)) (prev goal)))

  (object Ball (: direction Integer) (: color String) (Cell 0 0 color))
  (object Wall (: visible Bool)(list (Cell 0 0 (if visible then "black" else "white")) (Cell 0 1 (if visible then "black" else "white")) (Cell 0 2 (if visible then "black" else "white"))))

  (: wall Wall)
  (= wall (initnext (Wall true (Position 4 9)) (prev wall)))

  (= nextBall (fn (ball)
                (if (== (.. ball direction) 1)
  then (updateObj ball "origin"
         (Position (.. (.. ball origin) x) (- (.. (.. ball origin) y) 1)))
  else
  (if (== (.. ball direction) 2)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
  else
  (if (== (.. ball direction) 3)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
  else
  (if (== (.. ball direction) 4)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
  else
  (if (== (.. ball direction) 5)
  then (updateObj ball "origin"
         (Position (.. (.. ball origin) x) (+ (.. (.. ball origin) y) 1)))
  else
  (if (== (.. ball direction) 6)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
  else
  (if (== (.. ball direction) 7)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
  else
  (if (== (.. ball direction) 8)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
  else ball))))))))))


  (on (clicked wall) (= wall (updateObj wall "visible" (! (.. wall visible)))))

  (= wallintersect (fn (ball)
                     (if (& (== (.. ball direction) 4) (== (.. (.. ball origin) y) 15)) then 2 else
  (if (& (== (.. ball direction) 5) (== (.. (.. ball origin) y) 15)) then 1 else
  (if (& (== (.. ball direction) 6) (== (.. (.. ball origin) y) 15)) then 8 else
  (if (& (== (.. ball direction) 6) (== (.. (.. ball origin) x) 0)) then 4 else
  (if (& (== (.. ball direction) 7) (== (.. (.. ball origin) x) 0)) then 3 else
  (if (& (== (.. ball direction) 8) (== (.. (.. ball origin) x) 0)) then 2 else
  (if (& (== (.. ball direction) 2) (== (.. (.. ball origin) x) 15)) then 8 else
  (if (& (== (.. ball direction) 3) (== (.. (.. ball origin) x) 15)) then 7 else
  (if (& (== (.. ball direction) 4) (== (.. (.. ball origin) x) 15)) then 6 else
  (if (& (== (.. ball direction) 8) (== (.. (.. ball origin) y) 0)) then 6 else
  (if (& (== (.. ball direction) 1) (== (.. (.. ball origin) y) 0)) then 5 else
  (if (& (== (.. ball direction) 2) (== (.. (.. ball origin) y) 0)) then 4 else

  (.. ball direction)))))))))))))))


  (: ball_a Ball)
  (= ball_a (initnext (Ball 7 "blue" (Position 15 10)) (if (intersects ball_a ball_b) then (nextBall (updateObj (prev ball_a) "direction" 6)) else (nextBall (updateObj (prev ball_a) "direction" (wallintersect (prev ball_a)))))))

  (: ball_b Ball)
  (= ball_b (initnext (Ball 6 "red" (Position 15 5)) (if (intersects (prev ball_a) ball_b) then (nextBall (updateObj (prev ball_b) "direction" 2)) else (nextBall (updateObj (prev ball_b) "direction" (wallintersect (prev ball_b)))))))
  )`);
  }

  function balls2Click() { 
    model_name = "balls2";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Goal (Cell 0 0 "green"))
  (: goal Goal)
  (= goal (initnext (Goal (Position 0 10)) (prev goal)))

  (object Ball (: direction Integer) (: color String) (Cell 0 0 color))

  (= nextBall (fn (ball)
                (if (< (.. ball direction) 45)
  then (updateObj ball "origin"
         (Position (.. (.. ball origin) x) (- (.. (.. ball origin) y) 1)))
  else
  (if (< (.. ball direction) 90)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
  else
  (if (< (.. ball direction) 135)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
  else
  (if (< (.. ball direction) 180)
  then (updateObj ball "origin"
         (Position (+ (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
  else
  (if (< (.. ball direction) 225)
  then (updateObj ball "origin"
         (Position (.. (.. ball origin) x) (+ (.. (.. ball origin) y) 1)))
  else
  (if (< (.. ball direction) 270)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
  else
  (if (< (.. ball direction) 315)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
  else
  (if (< (.. ball direction) 360)
  then (updateObj ball "origin"
         (Position (- (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
  else ball))))))))))


  (on (clicked goal) (= goal (prev goal)))

  (= wallintersect (fn (ball)
                     (if (& (< (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then (- 180 (.. ball direction)) else
  (if (& (== (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then 0 else
  (if (& (> (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then (+ 90 (.. ball direction)) else
  (if (& (& (< (.. ball direction) 270) (> (.. ball direction) 180)) (== (.. (.. ball origin) x) 0)) then (- 360 (.. ball direction)) else
  (if (& (== (.. ball direction) 270) (== (.. (.. ball origin) x) 0)) then 90 else
  (if (& (> (.. ball direction) 270) (== (.. (.. ball origin) x) 0)) then (- 360 (.. ball direction)) else
  (if (& (< (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then (+ 270 (.. ball direction)) else
  (if (& (== (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then 270 else
  (if (& (> (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then (+ 90 (.. ball direction)) else
  (if (& (> (.. ball direction) 180) (== (.. (.. ball origin) y) 0)) then (- 520 (.. ball direction)) else
  (if (& (== (.. ball direction) 45) (== (.. (.. ball origin) y) 0)) then 180 else
  (if (& (< (.. ball direction) 180) (== (.. (.. ball origin) y) 0)) then (- 180 (.. ball direction)) else
  (.. ball direction)))))))))))))))

  (= ballcollision (fn (ball1 ball2)
                     (.. ball2 direction)
          ))

  (: ball_a Ball)
  (= ball_a (initnext (Ball 361 "blue" (Position 6 10)) (if (intersects ball_a ball_b) then (nextBall (updateObj (prev ball_a) "direction" (ballcollision (prev ball_a) (prev ball_b)))) else (nextBall (updateObj (prev ball_a) "direction" (wallintersect (prev ball_a)))))))

  (: ball_b Ball)
  (= ball_b (initnext (Ball 361 "red" (Position 10 10)) (if (intersects ball_b ball_c) then (nextBall (updateObj (prev ball_b) "direction" (ballcollision (prev ball_b) (prev ball_c)))) else (if (intersects (prev ball_a) ball_b) then (nextBall (updateObj (prev ball_b) "direction" 361)) else (nextBall (updateObj (prev ball_b) "direction" (wallintersect (prev ball_b))))))))

  (: ball_c Ball)
  (= ball_c (initnext (Ball 270 "purple" (Position 14 10)) (if (intersects (prev ball_b) ball_c) then (nextBall (updateObj (prev ball_c) "direction" 361)) else (nextBall (updateObj (prev ball_c) "direction" (wallintersect (prev ball_c)))))))

  (on (intersects ball_a goal) (= ball_a (updateObj ball_a "direction" 361)))
)`);
  }

  function spaceInvadersClick() {
    model_name = "space_invaders";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Enemy (Cell 0 0 "blue"))
(object Hero (Cell 0 0 "black"))
(object Bullet (Cell 0 0 "red"))
(object EnemyBullet (Cell 0 0 "orange"))

(: enemies1 (List Enemy))
(= enemies1 (initnext (map 
                        (--> pos (Enemy pos)) 
                        (filter (--> pos (& (== (.. pos y) 1) (== (% (.. pos x) 3) 1))) (allPositions GRID_SIZE)))
                      (prev enemies1)))

(: enemies2 (List Enemy))
(= enemies2 (initnext (map 
                        (--> pos (Enemy pos)) 
                        (filter (--> pos (& (== (.. pos y) 3) (== (% (.. pos x) 3) 2))) (allPositions GRID_SIZE)))
                      (prev enemies2)))


(: hero Hero)
(= hero (initnext (Hero (Position 8 15)) (prev hero)))

(: enemyBullets (List EnemyBullet))
(= enemyBullets (initnext (list) (prev enemyBullets)))

(: bullets (List Bullet))
(= bullets (initnext (list) (prev bullets)))

(: time Int)
(= time (initnext 0 (+ (prev time) 1)))                                                         

(on true (= enemyBullets (updateObj enemyBullets (--> obj (moveDown obj)))))
(on true (= bullets (updateObj bullets (--> obj (moveUp obj)))))
(on left (= hero (moveLeftNoCollision (prev hero))))
(on right (= hero (moveRightNoCollision (prev hero))))
(on (& up (.. (prev hero) alive)) (= bullets (addObj bullets (Bullet (.. (prev hero) origin)))))  

(on (== (% time 10) 5) (= enemies1 (updateObj enemies1 (--> obj (moveLeft obj)))))
(on (== (% time 10) 0) (= enemies1 (updateObj enemies1 (--> obj (moveRight obj)))))

(on (== (% time 10) 5) (= enemies2 (updateObj enemies2 (--> obj (moveRight obj)))))
(on (== (% time 10) 0) (= enemies2 (updateObj enemies2 (--> obj (moveLeft obj)))))

(on (intersects (prev bullets) (prev enemies1))
  (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies1)))))
        (= enemies1 (removeObj enemies1 (--> obj (intersects (prev obj) (prev bullets)))))))
)          
        
(on (intersects (prev bullets) (prev enemies2))
  (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies2)))))
        (= enemies2 (removeObj enemies2 (--> obj (intersects (prev obj) (prev bullets)))))))
)
        
(on (== (% time 5) 2) (= enemyBullets (addObj enemyBullets (EnemyBullet (uniformChoice (map (--> obj (.. obj origin)) (vcat (prev enemies1) (prev enemies2))))))))         
(on (intersects (prev hero) (prev enemyBullets)) (= hero (removeObj (prev hero))))

(on (intersects (prev bullets) (prev enemyBullets)) 
  (let 
    ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemyBullets))))) 
      (= enemyBullets (removeObj enemyBullets (--> obj (intersects (prev obj) (prev bullets))))))))           
)`)
  }

  function gameOfLifeClick() {
    model_name = "gol";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Particle (: living Bool) (Cell 0 0 (if living then "black" else "white")))
  
  (: particles (List Particle))
  (= particles 
     (initnext (map (--> pos (Particle false pos)) (allPositions GRID_SIZE)) 
               (prev particles))) 
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
    
  (on (& clicked (< time 20)) (= particles (addObj (removeObj (prev particles) (objClicked click particles)) (Particle true (Position (.. click x) (.. click y))))))
  (on (> time 20) (= particles 
                     (updateObj 
                       (prev particles) 
                       (--> obj 
                           (if (& (.. obj living) 
								  (| (<= (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 1)
                                     (>= (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 4))) 
							then (updateObj obj "living" false)
							else (if (& (! (.. obj living))
                                        (== (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 3))
								  then (updateObj obj "living" true)
                                  else obj))))))
)`)
  }

  function sokobanClick() {
    model_name = "sokoban_i";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Agent (Cell 0 0 "blue"))
(object Box (Cell 0 0 "black"))
(object Goal (Cell 0 0 "red"))

(: agent Agent)
(= agent (initnext (Agent (Position 7 4)) (prev agent)))
  
(: boxes (List Box))
(= boxes (initnext (list (Box (Position 14 2)) (Box (Position 9 14)) (Box (Position 1 2)) (Box (Position 0 4)) (Box (Position 4 4)) (Box (Position 9 9)) (Box (Position 10 9)) (Box (Position 0 11))) (prev boxes)))

(: goal Goal)
(= goal (initnext (Goal (Position 0 0)) (prev goal)))

(on left (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) -1 0)) 
              (= agent (moveAgent (prev agent) (prev boxes) (prev goal) -1 0))))) 

(on right (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 1 0)) 
                (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 1 0))))) 

(on up (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 -1)) 
            (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 -1))))) 

(on down (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 1)) 
              (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 1))))) 

(on (& clicked (isFree click)) (= boxes (addObj boxes (Box (Position (.. click x) (.. click y))))))

(: moveBoxes (-> (List Box) Agent Goal Int Int (List Box)))
(= moveBoxes (fn (boxes agent goal x y) 
                (updateObj boxes 
                  (--> obj (if (intersects (move obj x y) goal) then (removeObj obj) else (moveNoCollision obj x y))) 
                  (--> obj (== (displacement (.. obj origin) (.. agent origin)) (Position (- 0 x) (- 0 y)))))))

(: moveAgent (-> Agent (List Box) Goal Int Int Agent))
(= moveAgent (fn (agent boxes goal x y) 
                (if (intersects (list (move agent x y)) (moveBoxes boxes agent goal x y))
                  then agent 
                  else (move agent x y))))
)`)
  }

  function sokobanClick2() {
    model_name = "sokoban_ii";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 8)
  
  (object Agent (Cell 0 0 "blue"))
  (object Box (Cell 0 0 "darkorange"))
  (object Goal (Cell 0 0 "red"))
  (object Teleporter (Cell 0 0 "green"))
  (object Wall (Cell 0 0 "black"))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 3 3)) (prev agent)))
     
  (: boxes (List Box))
  (= boxes (initnext (list (Box (Position 1 6)) (Box (Position 4 1)) (Box (Position 6 4)) (Box (Position 3 6))) (prev boxes)))
 
  (: goal Goal)
  (= goal (initnext (Goal (Position 0 0)) (prev goal)))
  
  (: teleporter1 Teleporter)
  (= teleporter1 (initnext (Teleporter (Position 2 6)) (prev teleporter1)))

  (: teleporter2 Teleporter)
  (= teleporter2 (initnext (Teleporter (Position 0 4)) (prev teleporter2)))
  
  (: walls (List Wall))
  (= walls (initnext (list (Wall (Position 1 1)) 
                       	   (Wall (Position 1 2)) 
                           (Wall (Position 1 3)) 
                           (Wall (Position 1 4)) 
                           (Wall (Position 1 5))
                       	   (Wall (Position 2 1))
                           (Wall (Position 3 1))
                           (Wall (Position 5 1))
                       	   (Wall (Position 5 0))) (prev walls)))
  
  (on left (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) -1 0)) 
                 (= agent (moveAgent (prev agent) (prev boxes) (prev goal) -1 0))))) 

  (on right (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 1 0)) 
                  (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 1 0))))) 

  (on up (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 -1)) 
               (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 -1))))) 

  (on down (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 1)) 
                 (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 1))))) 
  
  (on (& clicked (isFree click)) (= boxes (addObj boxes (Box (Position (.. click x) (.. click y))))))

  (: moveBoxes (-> (List Box) Agent Goal Int Int (List Box)))
  (= moveBoxes (fn (boxes agent goal x y) 
                   (updateObj boxes 
                     (--> obj (if (intersects (move obj x y) goal) 
                               then (removeObj obj) 
                               else (if (& (intersects (move obj x y) (prev teleporter1)) (! (intersects (prev teleporter2) (prev boxes)))) 
                                     then (move obj (displacement (.. obj origin) (.. (prev teleporter2) origin))) 
									 else (moveNoCollision obj (Position x y))))) 
                     (--> obj (== (displacement (.. obj origin) (.. agent origin)) (Position (- 0 x) (- 0 y)))))))

  (: moveAgent (-> Agent (List Box) Goal Int Int Agent))
  (= moveAgent (fn (agent boxes goal x y) 
                   (if (| (| (intersects (list (move agent x y)) (moveBoxes boxes agent goal x y))
                             (intersects (list (move agent x y)) (prev walls)))
                          (! (isWithinBounds (move agent x y)))) 
                    then agent 
                    else (move agent x y))))
)`)
  }

  function growClick() {
    model_name = "grow";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 7)

(object Water (Cell 0 0 "blue"))
(object Leaf (: color String) (Cell 0 0 color))
(object Cloud (list (Cell -1 0 "gray") (Cell 0 0 "gray") (Cell 1 0 "gray")
                    (Cell -1 1 "gray") (Cell 0 1 "gray") (Cell 1 1 "gray")))

(object Sun (: movingLeft Bool) (list (Cell 0 0 "gold")
                              (Cell 0 1 "gold")
                                (Cell 1 0 "gold")
                              (Cell 1 1 "gold")))

(: sun Sun)
(= sun (initnext (Sun false (Position 0 0)) (prev sun)))

(: water (List Water))
(= water (initnext (list) (updateObj (prev water) (--> obj (if (! (isWithinBounds obj)) then (removeObj obj) else (moveDown obj))))))

(: cloud Cloud)
(= cloud (initnext (Cloud (Position 5 0)) (prev cloud)))

(: leaves (List Leaf))
(= leaves (initnext (list (Leaf "green" (Position 1 6) ) (Leaf "green" (Position 3 6)) (Leaf "green" (Position 5 6)) ) (prev leaves)))
    
(on down
  (= water (addObj (prev water) (Water (.. (moveDown (prev cloud)) origin)))))

(on (intersects (map (--> obj (moveDown obj)) (prev water) ) (prev leaves))
  (= water (removeObj (prev water) (--> obj (intersects (moveDown obj) (prev leaves))) ) ) )

(on (& (intersects (map (--> obj (moveDown obj)) (prev water)) (filter (--> obj (== (.. obj color) "green")) (prev leaves))) (! (intersects (prev sun) (prev cloud))))
  (= leaves (addObj (prev leaves) (map (--> obj (Leaf (if (== (.. (.. (moveUp obj) origin) y) 4) then "mediumpurple" else "green") (.. (moveUp obj) origin))) (filter (--> obj (intersects (moveUp obj) (prev water))) (prev leaves))))))
  
(on left (= cloud (moveLeft (prev cloud))))
(on right (= cloud (moveRight (prev cloud))))

(on (== (.. (.. (prev sun) origin) x) 0) (= sun (updateObj (prev sun) "movingLeft" false)))
(on (== (.. (.. (prev sun) origin) x) 5) (= sun (updateObj (prev sun) "movingLeft" true)))

(on (clicked (prev sun)) (= sun (if (.. (prev sun) movingLeft) then (moveLeft (prev sun)) else (moveRight (prev sun)))))
)`)
  }

  function marioClick() {
    model_name = "mario";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)
(= background "white")

(object Mario (: bullets Int) (Cell 0 0 "red"))
(object Step (list (Cell -1 0 "darkorange") (Cell 0 0 "darkorange") (Cell 1 0 "darkorange")))
(object Coin (Cell 0 0 "gold"))
(object Enemy (: movingLeft Bool) (: lives Int) (list (Cell -1 0 "blue") (Cell 0 0 "blue") (Cell 1 0 "blue")
                                    (Cell -1 1 "blue") (Cell 0 1 "blue") (Cell 1 1 "blue")))
(object Bullet (Cell 0 0 "mediumpurple"))

(: mario Mario)
(= mario (initnext (Mario 0 (Position 7 15)) (if (intersects (moveDown (prev mario)) (prev coins)) then (moveDown (prev mario)) else (moveDownNoCollision (prev mario)))))

(: steps (List Step))
(= steps (initnext (list (Step (Position 4 13)) (Step (Position 8 10)) (Step (Position 11 7))) (prev steps)))

(: coins (List Coin))
(= coins (initnext (list (Coin (Position 4 12)) (Coin (Position 7 4)) (Coin (Position 11 6))) (prev coins)))

(: enemy Enemy)
(= enemy (initnext (Enemy true 1 (Position 7 0)) (if (.. (prev enemy) movingLeft) then (moveLeft (prev enemy)) else (moveRight (prev enemy)))))

(: bullets (List Bullet))
(= bullets (initnext (list) (updateObj (prev bullets) (--> obj (if (intersects (moveUp obj) (prev steps)) then (removeObj obj) else (moveUp obj))))))

(: enemyLives Int)
(= enemyLives (initnext 1 (prev enemyLives)))

(on (== (.. (.. (prev enemy) origin) x) 1) (= enemy (moveRight (updateObj (prev enemy) "movingLeft" false))))
(on (== (.. (.. (prev enemy) origin) x) 14) (= enemy (moveLeft (updateObj (prev enemy) "movingLeft" true))))

(on left (= mario (if (intersects (moveLeft (prev mario)) (prev coins)) then (moveLeft (prev mario)) else (moveLeftNoCollision (prev mario)))))
(on right (= mario (if (intersects (moveRight (prev mario)) (prev coins)) then (moveRight (prev mario)) else (moveRightNoCollision (prev mario)))))
(on (& up (== (moveDownNoCollision (prev mario)) (prev mario))) (= mario (moveNoCollision (prev mario) 0 -4)))

(on (intersects (prev mario) (prev coins)) 
  (let ((= coins (removeObj (prev coins) (--> obj (intersects obj (prev mario))))) 
        (= mario (moveDownNoCollision (updateObj (prev mario) "bullets" (+ (.. (prev mario) bullets) 1)))))) )

(on (& clicked (> (.. (prev mario) bullets) 0)) 
  (let ((= bullets (addObj (prev bullets) (Bullet (.. (prev mario) origin)))) 
        (= mario (moveDownNoCollision (updateObj (prev mario) "bullets" (- (.. (prev mario) bullets) 1)))))))

(on (intersects (prev enemy) (prev bullets))
  (let ((= bullets (removeObj (prev bullets) (--> obj (intersects obj (prev enemy))))) 
        (= enemy (if (== (prev enemyLives) 1) then (removeObj (prev enemy)) else (if (.. (prev enemy) movingLeft) then (moveLeft (prev enemy)) else (moveRight (prev enemy))) ))
        (= enemyLives (- (prev enemyLives) 1)))))
)`)

  }

  function sandClick() {
    model_name = "sand";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 10)

(object Button (: color String) (Cell 0 0 color))
(object Sand (: liquid Bool) (Cell 0 0 (if liquid then "sandybrown" else "tan")))
(object Water (Cell 0 0 "skyblue"))

(: sandButton Button)
(= sandButton (initnext (Button "red" (Position 2 0)) (prev sandButton)))

(: waterButton Button)
(= waterButton (initnext (Button "green" (Position 7 0)) (prev waterButton)))

(: sand (List Sand))
(= sand (initnext (list) 
          (updateObj (prev sand) (--> obj (if (.. obj liquid) 
then (nextLiquid obj)
else (nextSolid obj))))))

(: water (List Water))
(= water (initnext (list) (updateObj (prev water) (--> obj (nextLiquid obj)))))


(: clickType String)
(= clickType (initnext "sand" (prev clickType)))

(on true (= sand (updateObj (prev sand) (--> obj (updateObj obj "liquid" true)) (--> obj (& (! (.. obj liquid)) (intersects (adjacentObjs obj 1) (prev water)))))))

(on (clicked sandButton) (= clickType "sand"))
(on (clicked waterButton) (= clickType "water"))
(on (& (& clicked (isFree click)) (== clickType "sand"))  (= sand (addObj sand (Sand false (Position (.. click x) (.. click y))))))
(on (& (& clicked (isFree click)) (== clickType "water")) (= water (addObj water (Water (Position (.. click x) (.. click y))))))

        )`)
  }

  function gravityClick() {
    model_name = "gravity_i";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 -1 "blue") (Cell 0 0 "blue") (Cell 1 -1 "blue") (Cell 1 0 "blue")))

(: leftButton Button)
(= leftButton (initnext (Button "red" (Position 0 7)) (prev leftButton)))

(: rightButton Button)
(= rightButton (initnext (Button "darkorange" (Position 15 7)) (prev rightButton)))
  
(: upButton Button)
(= upButton (initnext (Button "gold" (Position 7 0)) (prev upButton)))

(: downButton Button)
(= downButton (initnext (Button "green" (Position 7 15)) (prev downButton)))

(: blobs (List Blob))
(= blobs (initnext (list) (prev blobs)))

(: gravity String)
(= gravity (initnext "down" (prev gravity)))

(on (== gravity "left") (= blobs (updateObj blobs (--> obj (moveLef obj)))))
(on (== gravity "right") (= blobs (updateObj blobs (--> obj (moveRight obj)))))
(on (== gravity "up") (= blobs (updateObj blobs (--> obj (moveUp obj)))))
(on (== gravity "down") (= blobs (updateObj blobs (--> obj (moveDown obj)))))

(on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))) )

(on (clicked leftButton) (= gravity "left"))

(on (clicked rightButton) (= gravity "right"))

(on (clicked upButton) (= gravity "up"))

(on (clicked downButton) (= gravity "down"))
)`)
  }

  function gravity2Click() {
    model_name="gravity_ii";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 30)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (: color String) (list (Cell 0 -1 color) (Cell 0 0 color) (Cell 1 -1 color) (Cell 1 0 color)))

(: leftButton Button)
(= leftButton (initnext (Button "red" (Position 0 14)) (prev leftButton)))

(: rightButton Button)
(= rightButton (initnext (Button "darkorange" (Position 29 14)) (prev rightButton)))
  
(: upButton Button)
(= upButton (initnext (Button "gold" (Position 14 0)) (prev upButton)))

(: downButton Button)
(= downButton (initnext (Button "green" (Position 14 29)) (prev downButton)))

(: blobs (List Blob))
(= blobs (initnext (list) (prev blobs)))

(: gravity String)
(= gravity (initnext "down" (prev gravity)))

(: blobColor Int)
(= blobColor (initnext 0 (prev blobColor)))

(on (== gravity "left") (= blobs (updateObj (prev blobs) (--> obj (moveLeft obj)))))
(on (== gravity "right") (= blobs (updateObj (prev blobs) (--> obj (moveRight obj)))))
(on (== gravity "up") (= blobs (updateObj (prev blobs) (--> obj (moveUp obj)))))
(on (== gravity "down") (= blobs (updateObj (prev blobs) (--> obj (moveDown obj)))))

(on (& clicked (isFree click)) (= blobColor (% (+ (prev blobColor) 1) 3)))
(on (& (& clicked (isFree click)) (== blobColor 0)) (= blobs (addObj blobs (Blob "blue" (Position (.. click x) (.. click y))))))
(on (& (& clicked (isFree click)) (== blobColor 1)) (= blobs (addObj blobs (Blob "mediumpurple" (Position (.. click x) (.. click y))))))
(on (& (& clicked (isFree click)) (== blobColor 2)) (= blobs (addObj blobs (Blob "magenta" (Position (.. click x) (.. click y))))))

(on (clicked leftButton) (= gravity "left"))

(on (clicked rightButton) (= gravity "right"))

(on (clicked upButton) (= gravity "up"))

(on (clicked downButton) (= gravity "down"))
)`)
  }

  function gravity3Click() {
    model_name = "gravity_iii";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 40)
(= background "black")
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 19 19))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))
          
(on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))))

(on (& left (!= (prev xVel) -1)) (= xVel (- (prev xVel) 1)))
(on (& right (!= (prev xVel) 1)) (= xVel (+ (prev xVel) 1)))

(on (& up (!= (prev yVel) -1)) (= yVel (- (prev yVel) 1)))
(on (& down (!= (prev yVel) 1)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (prev xVel) (prev yVel)))))))
)`)
  }

  function gravity4Click() {
    model_name = "gravity_iv";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 -1 "black") (Cell 0 0 "black") (Cell 1 -1 "black") (Cell 1 0 "black")))

(: buttons (List Button))
(= buttons (initnext (list (Button "red" (Position 4 0)) 
            (Button "gold" (Position 8 0))                             
            (Button "darkorange" (Position 12 0))
                      
            (Button "lightgreen" (Position (- GRID_SIZE 1) 4))
                          (Button "green" (Position (- GRID_SIZE 1) 8))
                          (Button "lightseagreen" (Position (- GRID_SIZE 1) 12))
                          
                          (Button "lightblue" (Position 4 (- GRID_SIZE 1)))
                          (Button "blue" (Position 8 (- GRID_SIZE 1)))
                          

                      ) (prev buttons)))

(: blobs (List Blob))
(= blobs (initnext (list) (prev blobs)))

(: gravity String)
(= gravity (initnext "rr" (prev gravity)))
                                                                  
(on (== gravity "ul") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) -1 -2)))))
(on (== gravity "uu") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 0 -2)))))
(on (== gravity "ur") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 1 -2)))))

(on (== gravity "ru") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 -1)))))
(on (== gravity "rr") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 0)))))
(on (== gravity "rd") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 1)))))

(on (== gravity "dl") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) -1 2)))))
(on (== gravity "dd") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 0 2)))))


(on (clicked (filter (--> obj (== (.. obj color) "red")) (prev buttons))) (= gravity "ul"))
(on (clicked (filter (--> obj (== (.. obj color) "gold")) (prev buttons))) (= gravity "uu"))
(on (clicked (filter (--> obj (== (.. obj color) "darkorange")) (prev buttons))) (= gravity "ur"))

(on (clicked (filter (--> obj (== (.. obj color) "lightgreen")) (prev buttons))) (= gravity "ru"))
(on (clicked (filter (--> obj (== (.. obj color) "green")) (prev buttons))) (= gravity "rr"))
(on (clicked (filter (--> obj (== (.. obj color) "lightseagreen")) (prev buttons))) (= gravity "rd"))

(on (clicked (filter (--> obj (== (.. obj color) "lightblue")) (prev buttons))) (= gravity "dl"))
(on (clicked (filter (--> obj (== (.. obj color) "blue")) (prev buttons))) (= gravity "dd"))

(on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))))


)`)
  }

  function chargeClick() {
    model_name = "charge";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  
  (object Jumper (map (--> pos (Cell pos "red")) (rect (Position 0 0) (Position 1 1))))
  (object Stop (: gold Bool) (list (Cell 0 0 (if gold then "gold" else "blue")) (Cell 1 0 (if gold then "gold" else "blue"))))
    
  (: jumper Jumper)  
  (= jumper (initnext (Jumper (Position 0 (- GRID_SIZE 2))) (moveDownNoCollision (prev jumper))))

  (: stop Stop)
  (= stop (initnext (Stop false (Position 7 3)) (prev stop)))
  
  (: energy Int)
  (= energy (initnext 0 (prev energy)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
  
  (on left (= jumper (moveLeftNoCollision jumper)))
  (on right (= jumper (moveRightNoCollision jumper)))

  (on (& (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2)) (<= energy 10))
      (= energy (+ energy 1)))

  (on (& clicked (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2))) 
	  (let ((= jumper (move (prev jumper) (Position 0 (* -1 (prev energy)))))
           (= energy 0))))

  (on (intersects (prev stop) (adjacentObjs (prev jumper)))
  	  (= stop (updateObj stop "gold" (! (.. stop gold)))))

)`)
  }

  function eggClick() {
    model_name = "egg";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)
(= background "black")

(object Button (: color String) (Cell 0 0 color))
(object Piece (Cell 0 0 "gold"))
(object Egg (list (Cell -1 -2 "tan") (Cell 0 -2 "tan") (Cell 1 -2 "tan")  
                  (Cell -2 -1 "tan") (Cell -1 -1 "tan") (Cell 0 -1 "tan") (Cell 1 -1 "tan") (Cell 2 -1 "tan")
                  (Cell -2 0 "tan") (Cell -1 0 "tan") (Cell 0 0 "tan") (Cell 1 0 "tan") (Cell 2 0 "tan") 
                  (Cell -2 1 "tan") (Cell -1 1 "tan") (Cell 0 1 "tan") (Cell 1 1 "tan") (Cell 2 1 "tan") 
                (Cell -1 2 "tan") (Cell 0 2 "tan") (Cell 1 2 "tan")))

(: egg Egg)
(= egg (initnext (Egg (Position 7 13)) (prev egg)))

(: pieces (List Piece))
(= pieces (initnext (list) (updateObj (prev pieces) (--> obj (nextLiquid obj)))))

(: button Button)
(= button (initnext (Button "red" (Position 0 0)) (updateObj (prev button) "color" (if gravity then "pink" else "red"))))

(: gravity Bool)
(= gravity (initnext false (prev gravity)))

(: height Int)
(= height (initnext 15 (prev height)))

(on gravity (= egg (moveDownNoCollision (prev egg))))
  
(on (& left (! gravity)) (= egg (moveLeftNoCollision (prev egg))))
(on (& right (! gravity)) (= egg (moveRightNoCollision (prev egg))))
(on (& up (! gravity)) (= egg (moveUpNoCollision (prev egg))))
(on (& down (! gravity)) (= egg (moveDownNoCollision (prev egg))))

(on (clicked (prev button)) 
  (let ((= gravity (! (prev gravity)))
        (= height (.. (.. (prev egg) origin) y)))))

(on (& (< height 7) (== (.. (.. egg origin) y) 13)) 
  (let ((= egg (removeObj egg)) 
        (= pieces (addObj (prev pieces) (map (--> obj (Piece (Position (.. (.. obj position) x) (+ 1 (.. (.. obj position) y))))) (render (prev egg))))))))

)`)
  }

  function balloonClick() {
    model_name = "balloon";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "skyblue")
  
  (object Rock (Cell 0 0 "black"))
  (object Balloon (: color String) (list (Cell -1 -2 color) (Cell 0 -2 color) (Cell 1 -2 color)  
                      (Cell -2 -1 color) (Cell -1 -1 color) (Cell 0 -1 color) (Cell 1 -1 color) (Cell 2 -1 color)
                      (Cell -2 0 color) (Cell -1 0 color) (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) 
                      (Cell -2 1 color) (Cell -1 1 color) (Cell 0 1 color) (Cell 1 1 color) (Cell 2 1 color) 
                 	  (Cell -1 2 color) (Cell 0 2 color) (Cell 1 2 color) 
                      (Cell -1 3 "tan") (Cell 0 4 "tan") (Cell 1 3 "tan")
                      (Cell -1 5 "tan") (Cell 1 5 "tan")
                      (Cell -2 6 "brown") (Cell -2 7 "brown") (Cell -2 8 "brown")
                      (Cell 2 6 "brown") (Cell 2 7 "brown") (Cell 2 8 "brown")
                      (Cell -1 8 "brown") (Cell 0 8 "brown") (Cell 1 8 "brown")      
                  ))

  (: balloon Balloon)
  (= balloon (initnext (Balloon "mediumpurple" (Position 7 7)) (prev balloon)))
  
  (: rocks (List Rock))
  (= rocks (initnext (list) (updateObj (prev rocks) (--> obj (nextSolid obj)))) )
  
  (: weight Bool)
  (= weight (initnext false (prev weight)))
  
  (on (>= (count (--> pos (intersects (list pos) (map (--> obj (.. obj origin)) (filter (--> obj (intersects obj (nextSolid obj))) (prev rocks)))) ) 
           (rect (move (.. (prev balloon) origin) (Position -2 0)) 
				 (move (.. (prev balloon) origin) (Position 2 7)))) 3)
      (= weight true))

  (on (< (count (--> pos (intersects (list pos) (map (--> obj (.. obj origin)) (filter (--> obj (intersects obj (nextSolid obj))) (prev rocks)))) ) 
           (rect (move (.. (prev balloon) origin) (Position -2 0)) 
				 (move (.. (prev balloon) origin) (Position 2 7)))) 3)
      (= weight false))
  
  (on (prev weight) 
    (let 
       ((= rocks (updateObj 
                   (prev rocks) 
                   (--> obj (if (| (! (intersects obj (nextSolid obj))) (isWithinBounds (moveDown (prev balloon)))) then (moveDown obj) else obj)) 
                   (--> obj (intersects (list (.. obj origin)) 
							(rect (move (.. (prev balloon) origin) (Position -2 0)) 
				 				  (move (.. (prev balloon) origin) (Position 2 7)))))))
        (= balloon (if (! (isWithinBounds (moveDown (prev balloon)))) then (prev balloon) else (moveDown (prev balloon)))))))  

  (on (! (prev weight)) 
    (let 
       ((= rocks (updateObj 
                   (prev rocks) 
                   (--> obj (if (! (isWithinBounds (moveUp (prev balloon)))) then (nextSolid obj) else (moveUp obj))) 
                   (--> obj (intersects (list (.. obj origin)) 
							(rect (move (.. (prev balloon) origin) (Position -2 0)) 
				 				  (move (.. (prev balloon) origin) (Position 2 7)))))))
        (= balloon (if (! (isWithinBounds (moveUp (prev balloon)))) then (prev balloon) else (moveUp (prev balloon)))))))  
  
  (on (& clicked (isFree click)) (= rocks (addObj (prev rocks) (Rock (Position (.. click x) (.. click y ))))))

  (on (clicked (prev rocks)) 
    (= rocks (removeObj 
               (prev rocks) 
               (--> obj (== (.. obj id) (.. (objClicked click (prev rocks)) id)))))) 
)`)
  }

  function windClick() {
    model_name = "wind";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 17)

(object Water (Cell 0 0 "lightblue"))
(object Cloud (map (--> pos (Cell (.. pos x) (.. pos y) "gray")) (rect (Position 0 0) (Position 16 1))))

(: water (List Water))
(= water (initnext (list) (updateObj (prev water) (--> obj (removeObj obj)) (--> obj (! (isWithinBounds obj)))))) 
     
(: cloud Cloud)
(= cloud (initnext (Cloud (Position 0 0)) (prev cloud)))

(: wind Int)
(= wind (initnext 0 (prev wind)))

(: time Int)
(= time (initnext 0 (+ (prev time) 1)))

(on (== wind 0) (= water (updateObj (prev water) (--> obj (moveDown obj)))))
(on (== wind 1) (= water (updateObj (prev water) (--> obj (moveRight (moveDown obj))))))
(on (== wind -1) (= water (updateObj (prev water) (--> obj (moveLeft (moveDown obj))))))

(on true (= water (updateObj water (--> obj (removeObj (prev obj))) (--> obj (! (isWithinBounds (prev obj)))))))


(on left (= wind (if (== (prev wind) -1) then (prev wind) else (- (prev wind) 1))))
(on right (= wind (if (== (prev wind) 1) then (prev wind) else (+ (prev wind) 1))))


(on (== (% time 5) 2) 
  (= water (addObj 
            water 
            (map (--> pos (Water pos)) (list (Position 2 2)
                                              
                                            (Position 6 2)
                                            
                                            (Position 10 2)
                                            
                                            (Position 14 2))))))
)`)
  }

  function paintClick() {
    model_name = "paint";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Particle (: color String) (Cell 0 0 color))

(: particles (List Particle))
(= particles (initnext (list) (prev particles)))

(: currColor String)
(= currColor (initnext "red" (prev currColor)))

(on clicked (= particles (addObj (prev particles) (Particle currColor (Position (.. click x) (.. click y))))))
(on (& up (== (prev currColor) "red")) (= currColor "gold"))
(on (& up (== (prev currColor) "gold")) (= currColor "green"))
(on (& up (== (prev currColor) "green")) (= currColor "blue"))
(on (& up (== (prev currColor) "blue")) (= currColor "purple"))
(on (& up (== (prev currColor) "purple")) (= currColor "red"))
)`)
  }

  function chaseClick() {
    model_name = "chase";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)

(object Ant (Cell 0 0 "red"))
(object Agent (Cell 0 0 "green"))

(: ants (List Ant))
(= ants (initnext (list ) 
                  (prev ants)))

(: agent Agent)
(= agent (initnext (Agent (Position 7 5)) (prev agent))) 
                                                                                                                
(: time Int)
(= time (initnext 0 (+ (prev time) 1)))                                                                                                                   
                                
(on true (= ants (updateObj (prev ants) (--> obj (move obj (unitVector obj (closest obj Agent)))) )))
(on (== (% time 10) 5) (= ants (addObj ants (map Ant (randomPositions GRID_SIZE 1)))))

(on left (= agent (moveLeft (prev agent))))
(on right (= agent (moveRight (prev agent))))
(on up (= agent (moveUp (prev agent))))
(on down (= agent (moveDown (prev agent))))
        
(on (intersects (prev agent) (prev ants)) (= agent (removeObj (prev agent))))                                                                                                                   
)`)
  }

  function coinsClick() {
    model_name = "coins";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Agent (Cell 0 0 "red"))
  (object Coin (Cell 0 0 "gold"))
  (object Bullet (Cell 0 0 "mediumpurple"))

  (: agent Agent)
  (= agent (initnext (Agent (Position 7 9)) (prev agent)))

  (: coins (List Coin))
  (= coins (initnext (map (--> pos (Coin pos)) (filter (--> p (& (== (% (.. p y) 2) 0) (== (% (.. p x) 2) 0))) (rect (Position 3 2) (Position 12 4)))) (prev coins)))

  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: numBullets Int)
  (= numBullets (initnext 0 (prev numBullets)))
  
  (on left (= agent (moveLeft agent)))
  (on right (= agent (moveRight agent)))
  (on up (= agent (moveUp agent)))
  (on down (= agent (moveDown agent)))

  (on true (= bullets (updateObj bullets (--> obj (moveUp (prev obj))))))
  
  (on (& clicked (> (prev numBullets) 0)) 
      (let ((= numBullets (- (prev numBullets) 1)) 
            (= bullets (addObj bullets (Bullet (.. (prev agent) origin)))))))  

  (on (intersects (prev agent) (prev coins)) 
      (let ((= numBullets (+ (prev numBullets) 1)) 
            (= coins (removeObj coins (--> obj (intersects (prev obj) (prev agent))))))))
)`)
  }

  function count1Click() {
    model_name = "count_1";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))

(: xActive Bool)
(= xActive (initnext true (prev xActive)))

(on clicked (= xActive (! xActive)))

(on (& (& left xActive) (> (prev xVel) -1)) (= xVel (- (prev xVel) 1)))
(on (& (& right xActive) (< (prev xVel) 1)) (= xVel (+ (prev xVel) 1)))

(on (& (& up (! xActive)) (> (prev yVel) -1)) (= yVel (- (prev yVel) 1)))
(on (& (& down (! xActive)) (> (prev yVel) 1)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function count2Click() {
    model_name = "count_2";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))

(: xActive Bool)
(= xActive (initnext true (prev xActive)))

(on clicked (= xActive (! xActive)))

(on (& (& left xActive) (> (prev xVel) -2)) (= xVel (- (prev xVel) 1)))
(on (& (& right xActive) (< (prev xVel) 2)) (= xVel (+ (prev xVel) 1)))

(on (& (& up (! xActive)) (> (prev yVel) -2)) (= yVel (- (prev yVel) 1)))
(on (& (& down (! xActive)) (> (prev yVel) 2)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function count3Click() {
    model_name = "count_3";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))

(: xActive Bool)
(= xActive (initnext true (prev xActive)))

(on clicked (= xActive (! xActive)))

(on (& (& left xActive) (> (prev xVel) -3)) (= xVel (- (prev xVel) 1)))
(on (& (& right xActive) (< (prev xVel) 3)) (= xVel (+ (prev xVel) 1)))

(on (& (& up (! xActive)) (> (prev yVel) -3)) (= yVel (- (prev yVel) 1)))
(on (& (& down (! xActive)) (> (prev yVel) 3)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function count4Click() {
    model_name = "count_4";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))

(: xActive Bool)
(= xActive (initnext true (prev xActive)))

(on clicked (= xActive (! xActive)))

(on (& (& left xActive) (> (prev xVel) -4)) (= xVel (- (prev xVel) 1)))
(on (& (& right xActive) (< (prev xVel) 4)) (= xVel (+ (prev xVel) 1)))

(on (& (& up (! xActive)) (> (prev yVel) -4)) (= yVel (- (prev yVel) 1)))
(on (& (& down (! xActive)) (> (prev yVel) 4)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function count5Click() {
    model_name = "count_5";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))

(: xActive Bool)
(= xActive (initnext true (prev xActive)))

(on clicked (= xActive (! xActive)))

(on (& (& left xActive) (> (prev xVel) -5)) (= xVel (- (prev xVel) 1)))
(on (& (& right xActive) (< (prev xVel) 5)) (= xVel (+ (prev xVel) 1)))

(on (& (& up (! xActive)) (> (prev yVel) -5)) (= yVel (- (prev yVel) 1)))
(on (& (& down (! xActive)) (> (prev yVel) 5)) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function arcSlackClick() {
    model_name = "arc_slack";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Particle (: active Bool) (: green Bool) (Cell 0 0 (if green then "green" else "gold")))
  (object Button (: color String) (Cell 0 0 color))
  
  (: particles (List Particle))
  (= particles (initnext (list (Particle true true (Position 1 1)) (Particle false true (Position 5 5)) (Particle false false (Position 11 14)) (Particle false true (Position 4 8)) (Particle false false (Position 9 9)) (Particle false true (Position 1 13)) (Particle false false (Position 14 5)))  
               (prev particles)))

  (: colorButton Button)
  (= colorButton (initnext (Button "gray" (Position (- GRID_SIZE 1) 0)) (prev colorButton)))

  (: removeButton Button)
  (= removeButton (initnext (Button "orangered" (Position (- GRID_SIZE 1) 2)) (prev removeButton)))
  
  (on (clicked colorButton) (= particles (updateObj particles (--> obj (updateObj obj "green" (! (.. obj green)))) (--> obj (.. obj active)))))
  (on (clicked removeButton) (= particles (updateObj particles (--> obj (removeObj obj)) (--> obj (.. obj active)))))  
  (on (clicked particles) 
      (let ((= particles (updateObj particles (--> obj (updateObj obj "active" false)) (--> obj (!= obj (objClicked click particles)))))
            (= particles (updateObj particles (--> obj (updateObj obj "active" true)) (--> obj (== obj (objClicked click particles)))))) ))
  
  (on left (= particles (updateObj particles (--> obj (moveLeftNoCollision obj)) (--> obj (.. obj active)))))
  (on right (= particles (updateObj particles (--> obj (moveRightNoCollision obj)) (--> obj (.. obj active)))))
  (on up (= particles (updateObj particles (--> obj (moveUpNoCollision obj)) (--> obj (.. obj active)))))
  (on down (= particles (updateObj particles (--> obj (moveDownNoCollision obj)) (--> obj (.. obj active)))))
)
`)
  }

  function rinkClick() {
    model_name = "rink";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 28)
  (= background "black")
  
  (object Rink (map (--> pos (Cell pos "lightblue")) (rect (Position 0 0) (Position 21 21))))
  (object Skater (Cell 0 0 "red"))
   
  (: rink Rink)
  (= rink (initnext (Rink (Position 3 3)) (prev rink)) )
  
  (: skater Skater)
  (= skater (initnext (Skater (Position 0 0)) (prev skater)))
  
  (: slide String)
  (= slide (initnext "none" (prev slide)))
  
  (on left (= skater (moveLeft skater)))
  (on right (= skater (moveRight skater)))
  (on up (= skater (moveUp skater)))
  (on down (= skater (moveDown skater)))
    
  (on (& left (! (in slide (list "none" "right")))) (= slide "left"))
  (on (& right (! (in slide (list "none" "left")))) (= slide "right"))
  (on (& up (! (in slide (list "none" "down")))) (= slide "up"))
  (on (& down (! (in slide (list "none" "up")))) (= slide "down"))

  (on (== slide "left") (= skater (move (prev skater) -2 0)))
  (on (== slide "right") (= skater (move (prev skater) 2 0)))
  (on (== slide "up") (= skater (move (prev skater) 0 -2)))
  (on (== slide "down") (= skater (move (prev skater) 0 2)))

  
  (on (& (!= (prev slide) "none") (! (intersects (prev skater) rink))) 
    (= slide "none")) 
  
  (on (& (! (intersects (prev skater) rink)) (intersects skater rink)) 
    (= slide (if left then "left" else (if right then "right" else (if up then "up" else "down")))))    
)`)
  }

  function doubleCountClick() {
    model_name = "double_1";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 49 49))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))
  
(on (& (> (prev xVel) -1) (& left (== (prev yVel) 0))) (= xVel (- (prev xVel) 1)))
(on (& (< (prev xVel) 1) (& right (== (prev yVel) 0))) (= xVel (+ (prev xVel) 1)))

(on (& (> (prev yVel) -1) (& up (== (prev xVel) 0))) (= yVel (- (prev yVel) 1)))
(on (& (< (prev yVel) 1) (& down (== (prev xVel) 0))) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function doubleCount2Click() {
    model_name = "double_2";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 100)
  
(object Button (: color String) (Cell 0 0 color))
(object Blob (list (Cell 0 0 "blue")))

(: blobs (List Blob))
(= blobs (initnext (list (Blob (Position 49 49))) (prev blobs)))

(: xVel Int)
(= xVel (initnext 0 (prev xVel)))

(: yVel Int)
(= yVel (initnext 0 (prev yVel)))
  
(on (& (> (prev xVel) -2) (& left (== (prev yVel) 0))) (= xVel (- (prev xVel) 1)))
(on (& (< (prev xVel) 2) (& right (== (prev yVel) 0))) (= xVel (+ (prev xVel) 1)))

(on (& (> (prev yVel) -2) (& up (== (prev xVel) 0))) (= yVel (- (prev yVel) 1)))
(on (& (< (prev yVel) 2) (& down (== (prev xVel) 0))) (= yVel (+ (prev yVel) 1)))

(on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
  }

  function swapClick() {
    model_name = "swap";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 40)
  (= background "black")
  
  (object Blob (map (--> pos (Cell pos "mediumpurple")) (rect (Position 0 0) (Position 1 1))))
  (object Button (: color String) (Cell 0 0 color))
  
  (: button1 Button)
  (= button1 (initnext (Button "red" (Position 0 3)) (prev button1)))
  
  (: button2 Button)
  (= button2 (initnext (Button "gold" (Position 0 6)) (prev button2)))
  
  (: button3 Button)
  (= button3 (initnext (Button "green" (Position 0 9)) (prev button3)))
  
  (: button4 Button)
  (= button4 (initnext (Button "blue" (Position 0 12)) (prev button4)))
  
  (: button5 Button)
  (= button5 (initnext (Button "red" (Position (- GRID_SIZE 1) 3)) (prev button5)))
  
  (: button6 Button)
  (= button6 (initnext (Button "gold" (Position (- GRID_SIZE 1) 6)) (prev button6)))
  
  (: button7 Button)
  (= button7 (initnext (Button "green" (Position (- GRID_SIZE 1) 9)) (prev button7)))

  (: button8 Button)
  (= button8 (initnext (Button "blue" (Position (- GRID_SIZE 1) 12)) (prev button8)))
  
  (: swapButton Button)
  (= swapButton (initnext (Button "red" (Position (/ GRID_SIZE 2) 0)) (prev swapButton)))

  (: blob Blob)
  (= blob (initnext (Blob (Position (/ GRID_SIZE 2) (/ GRID_SIZE 2))) (prev blob)))  
  
  (: globalState String)
  (= globalState (initnext "none" (prev globalState)))
  
  (: swapState String)
  (= swapState (initnext 1 (prev swapState)))
  
  (on (== globalState "left") (= blob (moveLeftNoCollision blob)))
  (on (== globalState "right") (= blob (moveRightNoCollision blob)))
  (on (== globalState "up") (= blob (moveUpNoCollision blob)))
  (on (== globalState "down") (= blob (moveDownNoCollision blob)))
  
  (on (== globalState "left-up") (= blob (moveLeftNoCollision (moveUpNoCollision blob))))
  (on (== globalState "right-up") (= blob (moveRightNoCollision (moveUpNoCollision blob))))
  (on (== globalState "left-down") (= blob (moveLeftNoCollision (moveDownNoCollision blob))))
  (on (== globalState "right-down") (= blob (moveRightNoCollision (moveDownNoCollision blob))))

  (on (& (== swapState 1) (clicked button1)) (= globalState "left"))
  (on (& (== swapState 1) (clicked button2)) (= globalState "right"))
  (on (& (== swapState 1) (clicked button3)) (= globalState "up"))
  (on (& (== swapState 1) (clicked button4)) (= globalState "down"))
  
  (on (& (== swapState 2) (clicked button5)) (= globalState "left-up"))
  (on (& (== swapState 2) (clicked button6)) (= globalState "right-up"))
  (on (& (== swapState 2) (clicked button7)) (= globalState "left-down"))
  (on (& (== swapState 2) (clicked button8)) (= globalState "right-down"))
  
  (on (& (== (prev swapState) 1) (clicked swapButton)) 
    (let ((= swapState 2)
          (= globalState "left-up"))))
  
  (on (& (== (prev swapState) 2) (clicked swapButton)) 
    (let ((= swapState 1)
          (= globalState "left"))))

)
`)
  }
  
  function disease2Click() {
    model_name = "disease_2";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 30)
  (= background "black")
  
  (object Hospital (map (--> pos (Cell pos "darkorange")) (rect (Position 0 0) (Position 5 5))))
  (object DiseasePool (: color String) (map (--> pos (Cell pos color)) (rect (Position 0 0) (Position 5 5))))
  (object Person (: active Bool) (: health Int) (Cell 0 0 "mediumpurple"))
  
  (: hospital Hospital)
  (= hospital (initnext (Hospital (Position 0 0)) (prev hospital)))
  
  (: diseasePool1 DiseasePool)
  (= diseasePool1 (initnext (DiseasePool "darkgreen" (Position (- GRID_SIZE 6) 6)) (prev diseasePool1)))

  (: diseasePool2 DiseasePool)
  (= diseasePool2 (initnext (DiseasePool "darkblue" (Position (- GRID_SIZE 6) 12)) (prev diseasePool2)))

  (: diseasePool3 DiseasePool)
  (= diseasePool3 (initnext (DiseasePool "darkkhaki" (Position (- GRID_SIZE 6) 18)) (prev diseasePool3)))

  (: diseasePool4 DiseasePool)
  (= diseasePool4 (initnext (DiseasePool "gray" (Position 0 (- GRID_SIZE 6))) (prev diseasePool4)))

  (: people (List Person))
  (= people (initnext (list (Person true 6 (Position 14 15)) (Person false 6 (Position 7 1)) (Person false 6 (Position 2 10)) (Person false 6 (Position 11 11))) (prev people)))

  (on left (= people (updateObj people (--> obj (move obj (* -1 (.. obj health)) 0)) (--> obj (.. obj active)))))
  (on right (= people (updateObj people (--> obj (move obj (* 1 (.. obj health)) 0)) (--> obj (.. obj active)))))
  (on up (= people (updateObj people (--> obj (move obj 0 (* -1 (.. obj health)))) (--> obj (.. obj active)))))
  (on down (= people (updateObj people (--> obj (move obj 0 (* 1 (.. obj health)))) (--> obj (.. obj active)))))

  (on (clicked people) (let ((= people (updateObj people (--> obj (updateObj obj "active" false)) (--> obj (!= obj (objClicked click people)))))
                             (= people (updateObj people (--> obj (updateObj obj "active" true)) (--> obj (== obj (objClicked click people))))))))

  (on (& clicked (isFree click)) (let ((= people (updateObj people (--> obj (updateObj obj "active" false))))
                                       (= people (addObj people (Person true 6 (Position (.. click x) (.. click y))))))))

  (on (intersects (prev people) (prev hospital)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 6)) (--> obj (intersects obj hospital)))))  

  (on (intersects (prev people) (prev diseasePool1)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 3)) (--> obj (& (intersects obj diseasePool1) (> (.. obj health) 3))))))  

  (on (intersects (prev people) (prev diseasePool2)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 2)) (--> obj (& (intersects obj diseasePool2) (> (.. obj health) 2))))))  

  (on (intersects (prev people) (prev diseasePool3)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 1)) (--> obj (& (intersects obj diseasePool3) (> (.. obj health) 1))))))  

  (on (intersects (prev people) (prev diseasePool4)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 0)) (--> obj (intersects obj diseasePool4)))))  

)`)
  }

  function bulletsClick() {
    model_name = "bullets";
    myCodeMirror.setValue(`(program
(= GRID_SIZE 16)
(object Particle (Cell 0 0 "blue"))
(object Bullet (: dir String) (Cell 0 0 "red"))

(: particle Particle)
(= particle (initnext (Particle (Position 8 8)) (prev particle)))

(: bullets (List Bullet))
(= bullets (initnext (list) (prev bullets)))

(: dir String)
(= dir (initnext "none" (prev dir)))

(on true (= bullets (updateObj bullets (--> obj (moveLeft obj)) (--> obj (== (.. obj dir) "left")))))
(on true (= bullets (updateObj bullets (--> obj (moveRight obj)) (--> obj (== (.. obj dir) "right")))))
(on true (= bullets (updateObj bullets (--> obj (moveUp obj)) (--> obj (== (.. obj dir) "up")))))
(on true (= bullets (updateObj bullets (--> obj (moveDown obj)) (--> obj (== (.. obj dir) "down")))))

(on left (let ((= dir "left")
              (= particle (moveLeft particle)))))
(on right (let ((= dir "right")
                (= particle (moveRight particle)))))
(on up (let ((= dir "up")
            (= particle (moveUp particle)))))
(on down (let ((= dir "down")
              (= particle (moveDown particle)))))


(on (& clicked (== dir "left")) (= bullets (addObj bullets (Bullet "left" (.. (moveLeft particle) origin)))))
(on (& clicked (== dir "right")) (= bullets (addObj bullets (Bullet "right" (.. (moveRight particle) origin)))))
(on (& clicked (== dir "up")) (= bullets (addObj bullets (Bullet "up" (.. (moveUp particle) origin)))))
(on (& clicked (== dir "down")) (= bullets (addObj bullets (Bullet "down" (.. (moveDown particle) origin)))))
)`)
  }

  function levelsClick() {
    model_name = "levels";
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 40)
  (= background "black")
  
  (object Floor (map (--> pos (Cell pos "skyblue")) (rect (Position 0 0) (Position 35 0))))
  (object Agent (Cell 0 0 "red"))
  (object Stair (: color String) (list (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) (Cell 3 0 color) (Cell 4 0 color) 
                                   						(Cell 1 -1 color) (Cell 2 -1 color) (Cell 3 -1 color) (Cell 4 -1 color)
                                   										  (Cell 2 -2 color) (Cell 3 -2 color) (Cell 4 -2 color)
                                   															(Cell 3 -3 color) (Cell 4 -3 color)
                ))
  
  (object ReverseStair (: color String) (list (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) (Cell 3 0 color) (Cell 4 0 color) 
                                   			  (Cell 0 -1 color) (Cell 1 -1 color) (Cell 2 -1 color) (Cell 3 -1 color)
                                              (Cell 0 -2 color) (Cell 1 -2 color) (Cell 2 -2 color)
                                              (Cell 0 -3 color) (Cell 1 -3 color)
                ))
  
  (object Barrier (map (--> pos (Cell pos "blue")) (rect (Position 0 -1) (Position 0 1))))
  (object Barrier2 (map (--> pos (Cell pos "rebeccapurple")) (rect (Position 0 -1) (Position 0 1))))
  (object Bullet (: color String) (: dir String) (map (--> pos (Cell pos "mediumpurple")) (rect (Position -1 -1) (Position 1 0))))
  (object Ammo (Cell 0 0 "gold"))
  (object Goal (: color String) (map (--> pos (Cell pos color)) (rect (Position 0 0) (Position 3 3))))
   
  (: goal Goal)
  (= goal (initnext (Goal "darkorange" (Position 0 0)) (prev goal)))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 19 39)) (prev agent)))

  (: walls (List Wall))
  (= walls (initnext (list (Floor (Position 0 36)) 
                           (Floor (Position 4 32))
                           (Floor (Position 0 28))
                           (Floor (Position 4 24))
                           (Floor (Position 0 20))
                           (Floor (Position 4 16))
                           (Floor (Position 0 12))
                           (Floor (Position 4 8)) 
                           (Floor (Position 0 4))) 
                     (prev walls)))
  
  (: stairs (List Stair))
  (= stairs (initnext (list (Stair "green" (Position 35 39)) 
                            (Stair "green" (Position 35 31))
                            (Stair "green" (Position 35 23))
                            (Stair "green" (Position 35 15))
                            (Stair "green" (Position 35 7))) 
              		 (prev stairs)))
  
  (: reverseStairs (List ReverseStair))
  (= reverseStairs (initnext (list (ReverseStair "green" (Position 0 35)) 
                                   (ReverseStair "green" (Position 0 27))
                                   (ReverseStair "green" (Position 0 19))
                                   (ReverseStair "green" (Position 0 11))
                                   ) 
              		 (prev reverseStairs)))
  
  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: barriers (List Barrier))
  (= barriers (initnext (list (Barrier (Position 6  38))
                              (Barrier (Position 33 38)) (Barrier (Position 31 38))
                              (Barrier (Position 33 30)) (Barrier (Position 31 30)) (Barrier (Position 29 30))
                              (Barrier (Position 33 22)) (Barrier (Position 31 22)) (Barrier (Position 29 22)) (Barrier (Position 27 22)) (Barrier (Position 25 22))
                              (Barrier (Position 33 14)) (Barrier (Position 31 14)) (Barrier (Position 29 14)) (Barrier (Position 27 14)) (Barrier (Position 25 14)) (Barrier (Position 23 14)) (Barrier (Position 21 14))
                              (Barrier (Position 33 6))  (Barrier (Position 31 6))  (Barrier (Position 29 6))  (Barrier (Position 27 6))  (Barrier (Position 25 6))  (Barrier (Position 23 6))  (Barrier (Position 21 6))  (Barrier (Position 19 6)) (Barrier (Position 17 6))
                          
                              (Barrier (Position 6 34)) (Barrier (Position 8 34))
                              (Barrier (Position 6 26)) (Barrier (Position 8 26)) (Barrier (Position 10 26)) (Barrier (Position 12 26))
                              (Barrier (Position 6 18)) (Barrier (Position 8 18)) (Barrier (Position 10 18)) (Barrier (Position 12 18)) (Barrier (Position 14 18)) (Barrier (Position 16 18)) 
                              (Barrier (Position 6 10)) (Barrier (Position 8 10)) (Barrier (Position 10 10)) (Barrier (Position 12 10)) (Barrier (Position 14 10)) (Barrier (Position 16 10)) (Barrier (Position 18 10)) (Barrier (Position 20 10))
                              (Barrier (Position 6 2))   (Barrier (Position 8 2)) (Barrier (Position 10 2))  (Barrier (Position 12 2))   (Barrier (Position 14 2))   (Barrier (Position 16 2))   (Barrier (Position 18 2))   (Barrier (Position 20 2))   (Barrier (Position 22 2))   (Barrier (Position 24 2))
                              
                        ) 
                	 (prev barriers)))
  
  (: barriers2 (List Barrier2))
  (= barriers2 (initnext (list (Barrier2 (Position 34 38)) (Barrier2 (Position 5 38))
                               (Barrier2 (Position 34 30)) 
                               (Barrier2 (Position 34 22)) 
                               (Barrier2 (Position 34 14)) 
                               (Barrier2 (Position 34 6))  
                          
                               (Barrier2 (Position 5 34)) 
                               (Barrier2 (Position 5 26)) 
                               (Barrier2 (Position 5 18)) 
                               (Barrier2 (Position 5 10)) 
                               (Barrier2 (Position 5 2))                                
                        ) 
                	 (prev barriers2)))
  
  (: ammo (List Ammo))
  (= ammo (initnext (list (Ammo (Position 4 39)) (Ammo (Position 2 39)) (Ammo (Position 14 39))
                          (Ammo (Position 35 35)) (Ammo (Position 34 34))
                          (Ammo (Position 4 31)) (Ammo (Position 5 30)) (Ammo (Position 6 31))
                          (Ammo (Position 35 27)) (Ammo (Position 34 26)) (Ammo (Position 33 27)) (Ammo (Position 32 26))
                          (Ammo (Position 4 23)) (Ammo (Position 5 22)) (Ammo (Position 6 23)) (Ammo (Position 7 22)) (Ammo (Position 8 23))
                          (Ammo (Position 35 19)) (Ammo (Position 34 18)) (Ammo (Position 33 19)) (Ammo (Position 32 18)) (Ammo (Position 31 19)) (Ammo (Position 30 18))
                          (Ammo (Position 4 15)) (Ammo (Position 5 14)) (Ammo (Position 6 15)) (Ammo (Position 7 14)) (Ammo (Position 8 15)) (Ammo (Position 9 14)) (Ammo (Position 10 15))
                          (Ammo (Position 35 11)) (Ammo (Position 34 10)) (Ammo (Position 33 11)) (Ammo (Position 32 10)) (Ammo (Position 31 11)) (Ammo (Position 30 10)) (Ammo (Position 29 11)) (Ammo (Position 28 10))
                          (Ammo (Position 4 7)) (Ammo (Position 5 6)) (Ammo (Position 6 7)) (Ammo (Position 7 6)) (Ammo (Position 8 7)) (Ammo (Position 9 6)) (Ammo (Position 10 7)) (Ammo (Position 11 6)) (Ammo (Position 12 7))
                          (Ammo (Position 35 3)) (Ammo (Position 34 2)) (Ammo (Position 33 3)) (Ammo (Position 32 2)) (Ammo (Position 31 3)) (Ammo (Position 30 2)) (Ammo (Position 29 3)) (Ammo (Position 28 2)) (Ammo (Position 27 3)) (Ammo (Position 26 2))

                    
                    ) (prev ammo)))
  
  (: numBullets Int)
  (= numBullets (initnext 0 (prev numBullets)))

  (: bulletDir String)
  (= bulletDir (initnext "left" (prev bulletDir)))
  
  (on true (= bullets (updateObj bullets (--> obj (moveLeft (prev obj))) (--> obj (== (.. (prev obj) dir) "left")))))
  (on true (= bullets (updateObj bullets (--> obj (moveRight (prev obj))) (--> obj (== (.. (prev obj) dir) "right")))))

  (on true (= agent (moveDownNoCollision (prev agent))))
  (on left (= agent (moveLeftNoCollision (prev agent))))
  (on right (= agent (moveRightNoCollision (prev agent))))
  (on (& up (== (.. (prev agent) origin) (.. (moveDownNoCollision (prev agent)) origin))) (= agent (moveUpNoCollision (prev agent))))

  (on (& left (intersects (moveLeft (prev agent)) (prev ammo))) (= agent (moveLeft (prev agent))))
  (on (& right (intersects (moveRight (prev agent)) (prev ammo))) (= agent (moveRight (prev agent))))
  (on (& up (intersects (moveUp (prev agent)) (prev ammo))) (= agent (moveUp (prev agent))))

  
  (on left (= bulletDir "left"))
  (on right (= bulletDir "right"))
  
  (on (intersects (prev agent) (prev ammo)) 
      (let ((= ammo (removeObj ammo (--> obj (intersects (prev obj) (prev agent)))))
            (= numBullets (+ (prev numBullets) 1))
           )))
  
  (on (& clicked (> (prev numBullets) 0))
      (let ((= bullets (addObj bullets (Bullet "mediumpurple" (prev bulletDir) (.. (move (prev agent) (if (== (prev bulletDir) "left") then -1 else 1) 0) origin))))
            (= numBullets (- (prev numBullets) 1)))))
  
  (on (intersects (prev bullets) (prev barriers)) 
      (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev barriers)))))
            (= barriers (removeObj barriers (--> obj (intersects (prev obj) (prev bullets))))))))

  (on clicked (= barriers2 (updateObj barriers2 (--> obj (removeObj (prev obj))) (--> obj (! (intersects (prev barriers) (adjacentObjs (prev obj))))))))
  (on (intersects (moveLeft (prev agent)) (prev goal)) (= goal (updateObj (prev goal) "color" "lightgreen")))
)`)
  }

  function jumpClick() {
    myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  
  (object Jumper (map (--> pos (Cell pos "red")) (rect (Position 0 0) (Position 1 1))))
  (object Stop (: gold Bool) (list (Cell 0 0 (if gold then "gold" else "blue")) (Cell 1 0 (if gold then "gold" else "blue"))))
  
  
  (: jumper Jumper)
  (= jumper (initnext (Jumper (Position 0 (- GRID_SIZE 2))) (moveDownNoCollision (prev jumper))))

  (: stop Stop)
  (= stop (initnext (Stop false (Position (- (/ GRID_SIZE 2) 1) 2)) (prev stop)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))

  (: energy Int)
  (= energy (initnext 0 (prev energy)))
  
  (on left (= jumper (moveLeftNoCollision (prev jumper))))
  (on right (= jumper (moveRightNoCollision (prev jumper))))
  
  (on (& (<= (prev energy) 10) (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2)))
  	  (= energy (+ energy 1)))

  (on clicked (let ((= jumper (move (prev jumper) 0 (* -1 energy))) 
                    (= energy 0))))
 
  (on (intersects (prev jumper) (adjacentObjs (prev stop))) 
      (= stop (updateObj stop "gold" (! (.. stop gold)))))  
)`)
  }

  function toggleClick() {
    div = document.getElementById("button-div")
    if (div.style.display == "none") {
      div.style.display = "block";
    } else {
      div.style.display = "none";
    }
  }

  function randomClick() {

    console.log("randomClick")
    var xhr = new XMLHttpRequest(); 
    xhr.open("GET", host + '/random', true);

    //Send the proper header information along with the request
    xhr.onreadystatechange = function () { // Call a function when the state changes.
      if (this.readyState === 4 && this.status === 200) {
        content = JSON.parse(xhr.response)[0];
        console.log("content: "+content);
        myCodeMirror.setValue(content);
        compileClick();
      }
    };
    xhr.send();
  }

  function randomClick2() {
    console.log("randomClick2")
    var xhr = new XMLHttpRequest(); 
    xhr.open("GET", host + '/random2', true);

    //Send the proper header information along with the request
    xhr.onreadystatechange = function () { // Call a function when the state changes.
      if (this.readyState === 4 && this.status === 200) {
        content = JSON.parse(xhr.response)[0];
        console.log("content: "+content);
        myCodeMirror.setValue(content);
        compileClick();
      }
    };
    xhr.send();
  }

  function randomClick3() {
    console.log("randomClick3")
    var xhr = new XMLHttpRequest(); 
    xhr.open("GET", host + '/random3', true);

    //Send the proper header information along with the request
    xhr.onreadystatechange = function () { // Call a function when the state changes.
      if (this.readyState === 4 && this.status === 200) {
        content = JSON.parse(xhr.response)[0];
        console.log("content: "+content);
        myCodeMirror.setValue(content);
        compileClick();
      }
    };
    xhr.send();
  }

  function synthesizeClick() {
    console.log("synthesize")
    var xhr = new XMLHttpRequest(); 
    xhr.open("GET", host + '/synthesize?clientid='+client_id, true);

    //Send the proper header information along with the request
    xhr.onreadystatechange = function () { // Call a function when the state changes.
      if (this.readyState === 4 && this.status === 200) {
        document.getElementById("synthesize-button").innerHTML = "SYNTHESIZE";
        compileClick();
        content = JSON.parse(xhr.response)[0];
        console.log("content: "+content);
        myCodeMirror.setValue(content);
      }
    };
    document.getElementById("synthesize-button").innerHTML = "SYNTHESIZING...";
    xhr.send();

  }
    }
    )
  </script>
</div>

